<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSE Real-Time Communication</title>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ”„ Real-Time Communication with SSE (PHP)</h1>
      <p>
        <span class="status-indicator connected" id="statusIndicator"></span>
        <span id="statusText">Connecting...</span>
      </p>
      <p>Client ID: <code id="clientId" style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;"></code></p>
    </header>

    <div class="grid">
      <!-- Left: Broadcast & Direct Messages -->
      <div class="card">
        <h2>Send Messages</h2>

        <div id="successMessage" class="success" style="display: none;"></div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div class="form-group">
          <label>Broadcast (to all clients):</label>
          <div class="control-group">
            <input 
              type="text" 
              id="broadcastInput" 
              placeholder="Type message and press Send"
              disabled
            >
            <button id="broadcastBtn" disabled>Send</button>
          </div>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

        <div class="form-group">
          <label>Send Direct Message:</label>
          <select id="targetClient" disabled>
            <option value="">Select recipient...</option>
          </select>
        </div>

        <div class="form-group">
          <input 
            type="text" 
            id="directInput" 
            placeholder="Message to send"
            disabled
          >
          <button id="directBtn" style="width: 100%; margin-top: 8px;" disabled>Send Direct</button>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

        <h3 style="margin-top: 20px; margin-bottom: 10px; color: #2c3e50;">Connected Clients (<span id="clientCount">0</span>)</h3>
        <ul class="clients-list" id="clientsList">
          <li style="color: #95a5a6;">No clients connected yet</li>
        </ul>
      </div>

      <!-- Right: Message Log -->
      <div class="card">
        <h2>Message Log</h2>
        <div class="message-log" id="messageLog">
          <div class="message system">
            <span class="message-type">SYSTEM</span>
            <span class="message-time">--:--:--</span>
            Waiting for connection...
          </div>
        </div>
        <button 
          id="clearBtn" 
          style="width: 100%; margin-top: 10px;"
        >Clear Log</button>
      </div>
    </div>

    <!-- Server Info -->
    <div class="card">
      <h2>API Endpoints (PHP)</h2>
      <p><strong>Server Status:</strong> <span id="serverStatus">Checking...</span></p>
      <ul style="margin-top: 10px; padding-left: 20px;">
        <li><code>GET /sse.php?clientId=client1</code> - Connect to SSE stream</li>
        <li><code>POST /api.php?action=broadcast</code> - Send message to all clients</li>
        <li><code>POST /api.php?action=send</code> - Send message to specific client</li>
        <li><code>GET /api.php?action=clients</code> - Get list of connected clients</li>
        <li><code>GET /api.php?action=health</code> - Server health check</li>
      </ul>
    </div>
  </div>

  <script>
    // ===== Configuration =====
    const clientId = new URLSearchParams(location.search).get('clientId') || `client_${Math.random().toString(36).substr(2, 9)}`;
    const SERVER_URL = location.origin;
    
    // ===== DOM Elements =====
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const clientIdElement = document.getElementById('clientId');
    const messageLog = document.getElementById('messageLog');
    const broadcastInput = document.getElementById('broadcastInput');
    const broadcastBtn = document.getElementById('broadcastBtn');
    const directInput = document.getElementById('directInput');
    const directBtn = document.getElementById('directBtn');
    const targetClientSelect = document.getElementById('targetClient');
    const clientsList = document.getElementById('clientsList');
    const clientCount = document.getElementById('clientCount');
    const clearBtn = document.getElementById('clearBtn');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const serverStatus = document.getElementById('serverStatus');

    let eventSource = null;
    let connectedClients = new Set();

    // ===== Initialize =====
    clientIdElement.textContent = clientId;
    updateServerStatus();
    setInterval(updateServerStatus, 5000);

    // ===== Connect to SSE (PHP Version) =====
    function connectSSE() {
      eventSource = new EventSource(`sse.php?clientId=${clientId}`);


      eventSource.addEventListener('connected', (e) => {
        const data = JSON.parse(e.data);
        setStatus('connected', `Connected (${data.clientCount} clients online)`);
        logMessage('system', 'CONNECTED', `Connected to SSE server`);
        updateControlsState(true);
      });

      eventSource.addEventListener('global_message', (e) => {
        const data = JSON.parse(e.data);
        logMessage('global_message', `${data.sender}`, data.message);
      });

      eventSource.addEventListener('directed_message', (e) => {
        const data = JSON.parse(e.data);
        logMessage('directed_message', `${data.from} â†’ You`, data.message);
      });

      eventSource.addEventListener('client_joined', (e) => {
        const data = JSON.parse(e.data);
        logMessage('system', 'CLIENT_JOINED', `${data.clientId} joined (${data.totalClients} total)`);
        updateConnectedClients();
      });

      eventSource.addEventListener('client_left', (e) => {
        const data = JSON.parse(e.data);
        logMessage('system', 'CLIENT_LEFT', `${data.clientId} left (${data.totalClients} total)`);
        updateConnectedClients();
      });

      eventSource.onerror = (e) => {
        setStatus('disconnected', 'Connection lost. Reconnecting in 3 seconds...');
        logMessage('system', 'ERROR', 'Connection lost');
        updateControlsState(false);

        eventSource.close();
        setTimeout(connectSSE, 3000);
      };
    }

    connectSSE();

    // ===== Send Broadcast =====
    broadcastBtn.addEventListener('click', async () => {
      const message = broadcastInput.value.trim();
      if (!message) return;

      try {
        const response = await fetch(`api.php?action=broadcast`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, sender: clientId })
        });

        const data = await response.json();
        
        if (response.ok) {
          showSuccess(`Sent to ${data.recipientCount} clients`);
          logMessage('global_message', 'You (broadcast)', message);
          broadcastInput.value = '';
        } else {
          showError(data.error || 'Failed to broadcast');
        }
      } catch (err) {
        showError('Network error: ' + err.message);
      }
    });

    // ===== Send Direct Message =====
    directBtn.addEventListener('click', async () => {
      const to = targetClientSelect.value;
      const message = directInput.value.trim();

      if (!to || !message) {
        showError('Select recipient and enter message');
        return;
      }

      try {
        const response = await fetch(`api.php?action=send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to, message, from: clientId })
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess(`Message sent to ${to}`);
          logMessage('directed_message', `You â†’ ${to}`, message);
          directInput.value = '';
        } else {
          showError(data.error || 'Failed to send');
        }
      } catch (err) {
        showError('Network error: ' + err.message);
      }
    });

    // ===== Enter Key Support =====
    broadcastInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') broadcastBtn.click();
    });

    directInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') directBtn.click();
    });

    // ===== Helper Functions =====
    function setStatus(state, message) {
      statusIndicator.className = `status-indicator ${state}`;
      statusText.textContent = message;
    }

    function logMessage(type, sender, message) {
      const time = new Date().toLocaleTimeString();
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      messageEl.innerHTML = `
        <span class="message-type">${sender}</span>
        <span class="message-time">${time}</span>
        <div style="clear: right; margin-top: 4px;">${escapeHtml(message)}</div>
      `;

      messageLog.appendChild(messageEl);
      messageLog.scrollTop = messageLog.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateConnectedClients() {
      fetch(`api.php?action=clients`)
        .then(r => r.json())
        .then(data => {
          connectedClients = new Set(data.clients.map(c => c.clientId));
          clientCount.textContent = data.total;

          if (data.total === 0) {
            clientsList.innerHTML = '<li style="color: #95a5a6;">No clients connected</li>';
            targetClientSelect.innerHTML = '<option value="">Select recipient...</option>';
            return;
          }

          clientsList.innerHTML = data.clients
            .map(client => `
              <li class="${client.clientId === clientId ? 'active' : ''}">
                <span>${client.clientId}</span>
                <span class="badge">${client.status}</span>
              </li>
            `)
            .join('');

          targetClientSelect.innerHTML = '<option value="">Select recipient...</option>' +
            data.clients
              .filter(c => c.clientId !== clientId)
              .map(c => `<option value="${c.clientId}">${c.clientId}</option>`)
              .join('');
        })
        .catch(() => {
          logMessage('system', 'ERROR', 'Failed to fetch client list');
        });
    }

    function updateControlsState(connected) {
      broadcastInput.disabled = !connected;
      broadcastBtn.disabled = !connected;
      directInput.disabled = !connected;
      directBtn.disabled = !connected;
      targetClientSelect.disabled = !connected;
    }

    function updateServerStatus() {
      fetch(`api.php?action=health`)
        .then(r => r.json())
        .then(data => {
          serverStatus.textContent = `âœ“ Healthy (${data.activeConnections} connections)`;
        })
        .catch(() => {
          serverStatus.textContent = 'âœ— Unreachable';
        });
    }

    function showSuccess(msg) {
      successMessage.textContent = msg;
      successMessage.style.display = 'block';
      setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
    }

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.style.display = 'block';
      setTimeout(() => { errorMessage.style.display = 'none'; }, 3000);
    }

    // ===== Clear Log =====
    clearBtn.addEventListener('click', () => {
      messageLog.innerHTML = '';
    });

    // ===== Refresh Client List Every 2 Seconds =====
    setInterval(updateConnectedClients, 2000);

    // ===== Cleanup =====
    window.addEventListener('beforeunload', () => {
      if (eventSource) eventSource.close();
    });
  </script>
</body>
</html>
