<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anfitri√≥n - TalCual Party</title>
    <link rel="icon" href="/images/icon.webp" type="image/webp">
    <!-- CSS MODULARIZADO -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="tv-layout">
        <!-- HEADER con LOGO -->
        <div class="tv-header">
            <div class="logo-container">
                <img src="/images/logo.webp" alt="TalCual Party" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\'font-family: Fredoka One; font-size: 2.5em; text-shadow: 4px 4px 0px #000;\'>TalCual</span>'">
            </div>
            <div class="timer-display" id="timer-display">02:00</div>
            <div class="game-code-sticker" id="game-code-tv">------</div>
        </div>

        <!-- RANKING IZQUIERDA -->
        <div class="ranking-panel">
            <div class="ranking-title">üèÜ RANKING</div>
            <div id="ranking-list"></div>
        </div>

        <!-- CENTRO - Palabra/Estado -->
        <div class="center-panel">
            <div class="status-message" id="status-message">Esperando jugadores...</div>
            <div class="word-display" id="word-display" style="display: none;"></div>
            <div class="countdown-display" id="countdown-display" style="display: none;"></div>
        </div>

        <!-- TOP PALABRAS DERECHA -->
        <div class="top-words-panel">
            <div class="top-words-title">üìä TOP PALABRAS</div>
            <div id="top-words-list"></div>
        </div>

        <!-- JUGADORES ABAJO -->
        <div class="players-grid" id="players-grid"></div>
    </div>

    <!-- CONTROLES (Presiona 'C' para mostrar) -->
    <div class="controls-panel" id="controls-panel">
        <button class="btn-control btn-start" id="btn-start-round">‚ñ∂Ô∏è Iniciar Ronda</button>
        <button class="btn-control btn-end" id="btn-end-round">‚èπÔ∏è Finalizar Ronda</button>
        <button class="btn-control btn-next" id="btn-new-game">üîÑ Nueva Partida</button>
    </div>

    <script src="/js/game-client.js"></script>
    <script>
        const gameId = localStorage.getItem('gameId');
        if (!gameId || localStorage.getItem('isHost') !== 'true') {
            window.location.href = 'index.html';
        }

        document.getElementById('game-code-tv').textContent = gameId;
        console.log('üéÆ Host iniciando. GameID:', gameId);

        // FIX: Crear el juego ANTES de conectar al SSE
        async function initializeHost() {
            try {
                console.log('üîß Verificando si el juego existe...');
                
                // Intentar obtener el estado del juego
                const checkResponse = await fetch('/app/api/actions.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'get_state',
                        game_id: gameId
                    })
                });
                
                const checkData = await checkResponse.json();
                
                if (!checkData.success) {
                    // El juego no existe, crearlo
                    console.log('‚ö†Ô∏è Juego no encontrado, creando nuevo juego...');
                    
                    const createResponse = await fetch('/app/api/actions.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'create_game'
                        })
                    });
                    
                    const createData = await createResponse.json();
                    
                    if (createData.success) {
                        const newGameId = createData.game_id;
                        console.log('‚úÖ Juego creado con ID:', newGameId);
                        
                        // Actualizar el gameId en localStorage y la UI
                        localStorage.setItem('gameId', newGameId);
                        document.getElementById('game-code-tv').textContent = newGameId;
                        
                        // Reconectar con el nuevo gameId
                        window.location.reload();
                        return;
                    } else {
                        console.error('‚ùå Error creando el juego:', createData.message);
                        alert('Error al crear el juego. Intenta nuevamente.');
                        window.location.href = 'index.html';
                        return;
                    }
                } else {
                    console.log('‚úÖ Juego encontrado, conectando...');
                }
                
                // Conectar al SSE
                const client = new GameClient(gameId, 'host');
                window.client = client; // Hacer global para los event listeners
                
                client.onStateUpdate = (state) => {
                    console.log('üîÑ Estado actualizado en host:', state);
                    updateHostUI(state);
                };

                console.log('üîå Conectando SSE...');
                client.connect();
                
            } catch (error) {
                console.error('‚ùå Error inicializando host:', error);
                alert('Error al conectar con el servidor.');
                window.location.href = 'index.html';
            }
        }

        // Inicializar
        initializeHost();

        let timerInterval = null;
        let autoShortenTriggered = false;

        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'c') {
                document.getElementById('controls-panel').classList.toggle('visible');
            }
            if (e.key === 'Enter') {
                const startBtn = document.getElementById('btn-start-round');
                if (!startBtn.disabled) {
                    startBtn.click();
                }
            }
        });

        document.getElementById('btn-start-round').addEventListener('click', async () => {
            await startNewRound();
        });

        document.getElementById('btn-end-round').addEventListener('click', async () => {
            if (window.client) {
                await window.client.sendAction('end_round');
                stopTimer();
                autoShortenTriggered = false;
            }
        });

        document.getElementById('btn-new-game').addEventListener('click', async () => {
            if (window.client) {
                await window.client.sendAction('reset_game');
                autoShortenTriggered = false;
            }
        });

        async function startNewRound() {
            if (!window.client) {
                console.error('‚ùå Cliente no inicializado');
                return;
            }
            
            console.log('üé¨ Intentando iniciar ronda...');
            autoShortenTriggered = false;

            let attempts = 0;
            while (!window.client.gameState && attempts < 30) {
                console.log('‚è≥ Esperando estado del servidor... intento', attempts + 1);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (!window.client.gameState) {
                alert('No se pudo conectar con el servidor. Intenta recargar la p√°gina (F5).');
                console.error('‚ùå Estado no disponible despu√©s de 3 segundos');
                return;
            }

            const playerCount = Object.keys(window.client.gameState.players || {}).length;
            console.log('üë• Jugadores detectados:', playerCount);

            if (playerCount < 3) {
                alert(`Se necesitan al menos 3 jugadores para comenzar (tienes ${playerCount})`);
                return;
            }

            console.log('üìö Obteniendo lista de palabras...');
            const words = await getWordsList();
            console.log('üìö Palabras disponibles:', words.length);

            const randomWord = words[Math.floor(Math.random() * words.length)];
            console.log('üéØ Palabra seleccionada:', randomWord);

            showCountdownSynced();

            console.log('‚ñ∂Ô∏è Iniciando ronda...');
            await window.client.sendAction('start_round', { 
                word: randomWord,
                duration: 120
            });
        }

        function showCountdownSynced() {
            const countdownEl = document.getElementById('countdown-display');
            const statusEl = document.getElementById('status-message');
            const wordEl = document.getElementById('word-display');

            statusEl.style.display = 'none';
            wordEl.style.display = 'none';
            countdownEl.style.display = 'block';

            const countdownInterval = setInterval(() => {
                if (!window.client || !window.client.gameState || !window.client.gameState.round_start_at) {
                    return;
                }

                const now = Math.floor(Date.now() / 1000);
                const remaining = window.client.gameState.round_start_at - now;

                if (remaining > 0 && remaining <= 3) {
                    countdownEl.textContent = remaining;
                    countdownEl.style.animation = 'none';
                    setTimeout(() => {
                        countdownEl.style.animation = 'countdownPulse 1s ease-in-out';
                    }, 10);
                } else if (remaining <= 0) {
                    countdownEl.style.display = 'none';
                    clearInterval(countdownInterval);
                }
            }, 100);

            setTimeout(() => {
                countdownEl.style.display = 'none';
                clearInterval(countdownInterval);
            }, 4000);
        }

        async function getWordsList() {
            const response = await fetch('/app/api/actions.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'get_words' })
            });
            const data = await response.json();
            return data.words || [];
        }

        function startTimer(startTimestamp, duration) {
            stopTimer();

            timerInterval = setInterval(() => {
                const remaining = getRemainingTime(startTimestamp, duration);
                updateTimerDisplay(remaining);

                if (remaining <= 0) {
                    stopTimer();
                    autoEndRound();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay(remaining) {
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const timerEl = document.getElementById('timer-display');
            timerEl.textContent = display;

            if (remaining <= 30) {
                timerEl.classList.add('warning');
            } else {
                timerEl.classList.remove('warning');
            }
        }

        function getRemainingTime(startTimestamp, duration) {
            const now = Math.floor(Date.now() / 1000);
            const elapsed = now - startTimestamp;
            return Math.max(0, duration - elapsed);
        }

        async function autoEndRound() {
            if (window.client) {
                await window.client.sendAction('end_round');
            }
        }

        function updateHostUI(state) {
            if (!state) {
                console.warn('‚ö†Ô∏è Estado vac√≠o recibido');
                return;
            }

            const playerCount = Object.keys(state.players || {}).length;
            const statusEl = document.getElementById('status-message');
            const wordEl = document.getElementById('word-display');

            if (state.status === 'waiting') {
                statusEl.style.display = 'block';
                wordEl.style.display = 'none';

                if (playerCount < 3) {
                    statusEl.textContent = `Esperando m√°s jugadores... (${playerCount}/3 m√≠nimo)`;
                } else {
                    statusEl.textContent = `Presiona ENTER para comenzar (${playerCount} jugadores listos)`;
                }

                stopTimer();
            } else if (state.status === 'playing') {
                statusEl.style.display = 'none';
                wordEl.style.display = 'block';
                wordEl.textContent = state.current_word || '';

                if (state.round_started_at) {
                    startTimer(state.round_started_at, state.round_duration);
                }

                checkAllPlayersReady(state);
            } else if (state.status === 'round_ended') {
                statusEl.style.display = 'block';
                wordEl.style.display = 'none';

                if (playerCount < 3) {
                    statusEl.textContent = 'Se necesitan al menos 3 jugadores para continuar';
                } else {
                    statusEl.textContent = 'Ronda Finalizada - Presiona ENTER para continuar';
                }

                stopTimer();
            } else if (state.status === 'finished') {
                statusEl.style.display = 'block';
                wordEl.style.display = 'none';
                statusEl.textContent = 'üèÜ ¬°Partida Finalizada!';
                stopTimer();
            }

            updateRanking(state);
            updateTopWords(state);
            updatePlayersGrid(state);
            updateControls(state);
        }

        function checkAllPlayersReady(state) {
            if (autoShortenTriggered) return;

            const players = Object.values(state.players || {});
            const notReadyCount = players.filter(p => p.status !== 'ready').length;
            const remaining = getRemainingTime(state.round_started_at, state.round_duration);

            if (notReadyCount === 0 && remaining > 5 && players.length > 0) {
                console.log('‚úÖ Todos los jugadores terminaron, acortando timer a 5 segundos');
                autoShortenTriggered = true;
                if (window.client) {
                    window.client.sendAction('shorten_round');
                }
            }
        }

        function updateControls(state) {
            if (!state) return;

            const playerCount = Object.keys(state.players || {}).length;
            const startBtn = document.getElementById('btn-start-round');
            const endBtn = document.getElementById('btn-end-round');

            if (state.status === 'waiting') {
                startBtn.disabled = playerCount < 3;
                startBtn.textContent = playerCount < 3 
                    ? `‚è∏Ô∏è Min. 3 jugadores (${playerCount}/3)` 
                    : `‚ñ∂Ô∏è Iniciar Ronda (${playerCount} jugadores)`;
                endBtn.disabled = true;
            } else if (state.status === 'playing') {
                startBtn.disabled = true;
                startBtn.textContent = '‚ñ∂Ô∏è Ronda en curso...';
                endBtn.disabled = false;
                endBtn.textContent = '‚èπÔ∏è Finalizar Ahora';
            } else if (state.status === 'round_ended') {
                startBtn.disabled = playerCount < 3;
                startBtn.textContent = playerCount < 3 
                    ? `‚è∏Ô∏è Min. 3 jugadores (${playerCount}/3)` 
                    : '‚ñ∂Ô∏è Siguiente Ronda';
                endBtn.disabled = true;
            } else if (state.status === 'finished') {
                startBtn.disabled = true;
                startBtn.textContent = 'üèÜ Partida Finalizada';
                endBtn.disabled = true;
            }
        }

        function updateRanking(state) {
            const players = Object.values(state.players || {});
            const sorted = players.sort((a, b) => b.score - a.score);

            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = sorted.map((player, index) => {
                const topClass = index === 0 ? 'top-1' : index === 1 ? 'top-2' : index === 2 ? 'top-3' : '';
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;

                return `
                    <div class="ranking-item ${topClass}">
                        <span>${medal} ${player.name}</span>
                        <span>${player.score} pts</span>
                    </div>
                `;
            }).join('');
        }

        function updateTopWords(state) {
            const topWordsList = document.getElementById('top-words-list');

            if (state.round_top_words && state.round_top_words.length > 0) {
                topWordsList.innerHTML = state.round_top_words.map((item, index) => `
                    <div class="top-word-item">
                        <span class="word">${index + 1}. ${item.word}</span>
                        <span class="count">${item.count}</span>
                    </div>
                `).join('');
            } else {
                topWordsList.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">No hay datos a√∫n</div>';
            }
        }

        function updatePlayersGrid(state) {
            const players = Object.values(state.players || {});
            const grid = document.getElementById('players-grid');

            grid.innerHTML = players.map(player => {
                const initial = player.name.charAt(0).toUpperCase();
                const statusIcon = player.status === 'ready' ? '‚úÖ' : 
                                  player.status === 'playing' ? '‚úçÔ∏è' : 'üü¢';
                const readyClass = player.status === 'ready' ? 'ready' : '';

                let squarcleStyle = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';
                if (player.color) {
                    const colors = player.color.split(',');
                    squarcleStyle = `background: linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 100%);`;
                }

                const answerCount = (player.answers || []).length;
                const maxWords = 6;
                const answersDisplay = state.status === 'playing' ? 
                    `<div class="player-answers-count">${answerCount}/${maxWords}</div>` : '';

                return `
                    <div class="player-squarcle ${readyClass}" style="${squarcleStyle}">
                        <span class="player-status-icon">${statusIcon}</span>
                        <div class="player-initial">${initial}</div>
                        <div class="player-name-label">${player.name}</div>
                        <div class="player-score-badge">${player.score}</div>
                        ${answersDisplay}
                    </div>
                `;
            }).join('');
        }

        console.log('‚úÖ Host configurado y listo');
    </script>
</body>
</html>