<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba SSE</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            padding: 20px;
            border: 2px solid #00ff00;
            border-radius: 10px;
        }
        h1 { color: #00ff00; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected { background: #004400; }
        .error { background: #440000; }
        .message {
            padding: 5px;
            margin: 5px 0;
            background: #002200;
            border-left: 3px solid #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        #log {
            height: 400px;
            overflow-y: auto;
            background: #000;
            padding: 10px;
            border: 1px solid #00ff00;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Prueba de Server-Sent Events (SSE)</h1>

        <div id="status" class="status">
            Estado: <span id="status-text">Desconectado</span>
        </div>

        <div>
            <button onclick="testConnection()">ğŸ”Œ Probar ConexiÃ³n</button>
            <button onclick="createTestGame()">ğŸ® Crear Partida de Prueba</button>
            <button onclick="updateTestGame()">ğŸ“ Actualizar Estado</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ Limpiar Log</button>
        </div>

        <h3>ğŸ“‹ Log de Eventos:</h3>
        <div id="log"></div>
    </div>

    <script>
        let eventSource = null;
        let testGameId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff0000' : 
                         type === 'success' ? '#00ff00' : 
                         type === 'warning' ? '#ffff00' : '#00ff00';

            logDiv.innerHTML += `<div class="message" style="border-left-color: ${color}">
                [${time}] ${message}
            </div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(text, connected = false) {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            statusText.textContent = text;
            statusDiv.className = 'status ' + (connected ? 'connected' : 'error');
        }

        async function createTestGame() {
            log('Creando partida de prueba...', 'info');

            try {
                const response = await fetch('api-action.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'create_game' })
                });

                const data = await response.json();

                if (data.success) {
                    testGameId = data.game_id;
                    log(`âœ… Partida creada: ${testGameId}`, 'success');
                    log('Ahora puedes probar la conexiÃ³n SSE', 'info');
                } else {
                    log(`âŒ Error: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`âŒ Error de red: ${error.message}`, 'error');
            }
        }

        async function updateTestGame() {
            if (!testGameId) {
                log('âš ï¸ Primero crea una partida de prueba', 'warning');
                return;
            }

            log('Actualizando estado de la partida...', 'info');

            try {
                const response = await fetch('api-action.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'join_game',
                        game_id: testGameId,
                        player_id: 'test_player_' + Date.now(),
                        name: 'Jugador de Prueba'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    log(`âœ… Estado actualizado (deberÃ­as ver evento SSE)`, 'success');
                } else {
                    log(`âŒ Error: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        function testConnection() {
            if (!testGameId) {
                log('âš ï¸ Primero crea una partida de prueba', 'warning');
                return;
            }

            if (eventSource) {
                log('Cerrando conexiÃ³n anterior...', 'info');
                eventSource.close();
            }

            const url = `sse-stream.php?game_id=${testGameId}`;
            log(`Conectando a: ${url}`, 'info');

            eventSource = new EventSource(url);

            eventSource.onopen = function() {
                log('âœ… ConexiÃ³n SSE establecida', 'success');
                updateStatus('Conectado', true);
            };

            eventSource.addEventListener('update', function(event) {
                log(`ğŸ“¦ Evento recibido (update):`, 'success');
                try {
                    const data = JSON.parse(event.data);
                    log(`   Datos: ${JSON.stringify(data, null, 2)}`, 'info');
                } catch (e) {
                    log(`   âš ï¸ Error parseando JSON: ${e.message}`, 'warning');
                    log(`   Datos crudos: ${event.data}`, 'info');
                }
            });

            eventSource.onerror = function(error) {
                log('âŒ Error en SSE', 'error');
                console.error('SSE Error:', error);
                updateStatus('Error de conexiÃ³n', false);

                if (eventSource.readyState === EventSource.CLOSED) {
                    log('âš ï¸ ConexiÃ³n cerrada, reintentando en 3 segundos...', 'warning');
                    setTimeout(() => {
                        if (confirm('Â¿Reconectar?')) {
                            testConnection();
                        }
                    }, 3000);
                }
            };

            // Mensaje para comentarios (heartbeat)
            eventSource.addEventListener('message', function(event) {
                if (event.data.startsWith(':')) {
                    log(`ğŸ’“ Heartbeat recibido`, 'info');
                }
            });
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log limpiado', 'info');
        }

        // Log inicial
        log('ğŸš€ Sistema de prueba iniciado', 'info');
        log('ğŸ“ Pasos:', 'info');
        log('1. Clic en "Crear Partida de Prueba"', 'info');
        log('2. Clic en "Probar ConexiÃ³n" para conectar SSE', 'info');
        log('3. Clic en "Actualizar Estado" para generar eventos', 'info');
        log('4. Observa los eventos en este log', 'info');
    </script>
</body>
</html>