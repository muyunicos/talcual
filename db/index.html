<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalCual - Database Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100%;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .sidebar.collapsed {
            width: 70px;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 70px;
        }
        
        .sidebar-header h1 {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: opacity 0.3s ease, width 0.3s ease;
            flex: 1;
        }
        
        .sidebar.collapsed .sidebar-header h1 {
            opacity: 0;
            width: 0;
            display: none;
        }
        
        .sidebar-toggle {
            background: #334155;
            border: none;
            color: #e2e8f0;
            width: 40px;
            height: 40px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .sidebar-toggle:hover {
            background: #475569;
            color: #fff;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            transition: opacity 0.3s ease;
        }
        
        .sidebar.collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        
        .nav-section-title {
            padding: 12px 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #475569;
            letter-spacing: 0.8px;
            margin-top: 15px;
        }
        
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .nav-item:hover {
            background: #334155;
        }
        
        .nav-item.active {
            background: #1e40af;
            border-left-color: #3b82f6;
            color: #fff;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            padding: 20px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
        }
        
        .stat-label {
            color: #64748b;
            margin-top: 2px;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
        }
        
        .cascading-view {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            height: 100%;
        }
        
        .cascade-pane {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .cascade-header {
            padding: 15px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: #64748b;
        }
        
        .cascade-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .cascade-item {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            touch-action: none;
        }
        
        .cascade-item:hover {
            background: #334155;
        }
        
        .cascade-item.selected {
            background: #1e40af;
            color: #fff;
            border-left: 3px solid #3b82f6;
            padding-left: 12px;
        }
        
        .cascade-item.dragging {
            opacity: 0.5;
            background: #334155;
        }
        
        .cascade-item.drag-over {
            background: #2563eb;
            border-top: 2px solid #3b82f6;
        }
        
        .cascade-item-content {
            flex: 1;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .cascade-item-badge {
            background: #334155;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .cascade-item.selected .cascade-item-badge {
            background: #3b82f6;
        }
        
        .cascade-item-btn-delete {
            background: #dc2626;
            border: none;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: all 0.2s;
            padding: 0;
            flex-shrink: 0;
            min-width: 24px;
        }
        
        .cascade-item:hover .cascade-item-btn-delete {
            opacity: 1;
        }
        
        .cascade-item-btn-delete:hover {
            background: #b91c1c;
        }
        
        .cascade-empty {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #e2e8f0;
            font-family: inherit;
            font-size: 13px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            background: #0f172a;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #475569;
            color: #fff;
        }
        
        .btn-secondary:hover {
            background: #64748b;
        }
        
        .btn-danger {
            background: #dc2626;
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-success {
            background: #059669;
            color: #fff;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .message {
            padding: 12px 15px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.success {
            background: #064e3b;
            color: #86efac;
            border: 1px solid #059669;
            display: block;
        }
        
        .message.error {
            background: #7f1d1d;
            color: #fca5a5;
            border: 1px solid #dc2626;
            display: block;
        }
        
        .message.info {
            background: #1e3a8a;
            color: #bfdbfe;
            border: 1px solid #3b82f6;
            display: block;
        }
        
        .table-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            background: #0f172a;
            border-bottom: 2px solid #334155;
        }
        
        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            font-size: 11px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
        }
        
        tbody tr:hover {
            background: #334155;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #e2e8f0;
        }
        
        .modal-close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        
        .modal-close:hover {
            color: #e2e8f0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-warning {
            background: #78350f;
            border: 1px solid #b45309;
            color: #fde047;
        }
        
        .alert-info {
            background: #1e3a8a;
            border: 1px solid #3b82f6;
            color: #bfdbfe;
        }
        
        .schema-table {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .schema-table-name {
            padding: 15px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
            font-weight: 600;
            font-size: 14px;
            color: #3b82f6;
        }
        
        .schema-table-content {
            padding: 15px;
        }
        
        .schema-section {
            margin-bottom: 15px;
        }
        
        .schema-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .schema-item {
            padding: 8px 12px;
            background: #334155;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .schema-stat {
            display: inline-block;
            background: #1e40af;
            color: #e0f2fe;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        .batch-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .batch-section {
            display: flex;
            flex-direction: column;
        }
        
        .batch-section h4 {
            margin-bottom: 15px;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        .batch-pane {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .batch-list {
            flex: 1;
            overflow-y: auto;
            border-bottom: 1px solid #334155;
        }
        
        .batch-list-item {
            padding: 10px 15px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .batch-list-item:hover {
            background: #334155;
        }
        
        .batch-list-item.selected {
            background: #1e40af;
            color: #fff;
        }
        
        .batch-info {
            padding: 12px 15px;
            background: #0f172a;
            font-size: 11px;
            color: #64748b;
            text-align: center;
        }
        
        .import-preview {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .preview-item {
            padding: 6px;
            background: #0f172a;
            border-radius: 3px;
            margin-bottom: 5px;
            color: #e0f2fe;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>TalCual Admin</h1>
                <button class="sidebar-toggle" onclick="toggleSidebar()" title="Ocultar/mostrar">‚óÄ</button>
            </div>
            
            <div class="sidebar-content">
                <div class="nav-section-title">Diccionario</div>
                <div class="nav-item active" data-panel="dictionary" title="Gestor Cascada">üìö Gestor Cascada</div>
                <div class="nav-item" data-panel="batch-words" title="Lote de Palabras">üìã Lote de Palabras</div>
                
                <div class="nav-section-title">Herramientas</div>
                <div class="nav-item" data-panel="tools" title="Optimizaci√≥n">‚öôÔ∏è Optimizaci√≥n</div>
                <div class="nav-item" data-panel="import-export" title="Import/Export">üì§ Import/Export</div>
                <div class="nav-item" data-panel="inspect" title="Inspector">üîç Inspector</div>
            </div>
        </div>
        
        <div class="main">
            <div class="header">
                <h2 id="pageTitle">üìö Gestor de Diccionario</h2>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="catCount">0</div>
                        <div class="stat-label">Categor√≠as</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="promptCount">0</div>
                        <div class="stat-label">Consignas</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="wordCount">0</div>
                        <div class="stat-label">Palabras</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div id="message" class="message"></div>
                
                <!-- DICTIONARY PANEL -->
                <div id="dictionary" class="panel active">
                    <div class="cascading-view">
                        <!-- Categories Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">üìÅ Categor√≠as (Arrastra para reordenar)</div>
                            <div class="cascade-list" id="categoriesList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%;" onclick="openModal('addCategoryModal')">+ Nueva</button>
                            </div>
                        </div>
                        
                        <!-- Prompts Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">üí¨ Consignas</div>
                            <div class="cascade-list" id="promptsList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%;" onclick="openModal('addPromptModal')">+ Nueva</button>
                            </div>
                        </div>
                        
                        <!-- Words Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">üìù Palabras</div>
                            <div class="cascade-list" id="wordsList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%;" onclick="openModal('addWordModal')">+ Nueva</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BATCH WORDS PANEL -->
                <div id="batch-words" class="panel">
                    <h3 style="margin-bottom: 20px;">üìã Agregar Palabras por Lote</h3>
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è Selecciona una categor√≠a y consigna para precargar palabras actuales
                    </div>
                    
                    <div class="batch-grid">
                        <!-- Left: Category & Prompt Selection -->
                        <div class="batch-section">
                            <h4>üìÅ Categor√≠a</h4>
                            <div class="batch-pane">
                                <div class="batch-list" id="batchCategoriesList"></div>
                                <div class="batch-info" id="batchCatInfo">-- Selecciona --</div>
                            </div>
                        </div>
                        
                        <!-- Middle: Prompts in selected category -->
                        <div class="batch-section">
                            <h4>üí¨ Consigna</h4>
                            <div class="batch-pane">
                                <div class="batch-list" id="batchPromptsList"></div>
                                <div class="batch-info" id="batchPromptInfo">-- Selecciona --</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Palabras (una por l√≠nea, usa | para sin√≥nimos):</label>
                        <textarea id="batchWordsInput" placeholder="Flores|Ramo|Rosas&#10;Bombones|Chocolates|Bomb√≥n&#10;Perfume|Fragancia"></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-primary" onclick="loadBatchWords()" style="flex: 1;">üì• Cargar Palabras</button>
                        <button class="btn-success" onclick="replaceBatchWords()" style="flex: 1;" id="updateBtnBatch">‚úì Actualizar Consigna</button>
                    </div>
                </div>
                
                <!-- TOOLS PANEL -->
                <div id="tools" class="panel">
                    <h3 style="margin-bottom: 20px;">‚öôÔ∏è Herramientas de Optimizaci√≥n</h3>
                    
                    <div class="form-group">
                        <button class="btn-success" onclick="optimizeDatabase()" style="width: 100%; padding: 12px;">üîß Optimizar Base de Datos</button>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn-secondary" onclick="runDiagnostic()" style="width: 100%; padding: 12px;">üîç Ejecutar Diagn√≥stico</button>
                    </div>
                </div>
                
                <!-- IMPORT/EXPORT PANEL -->
                <div id="import-export" class="panel">
                    <h3 style="margin-bottom: 20px;">üì§ Importar / Exportar</h3>
                    
                    <div class="alert alert-info">
                        üí° <strong>Formato Compacto:</strong> {"Categor√≠a": [{"Pregunta": ["Palabra1|Sin1", "Palabra2|Sin2"]}]}
                    </div>
                    
                    <div class="form-group">
                        <label>Importar JSON:</label>
                        <textarea id="importData" placeholder="Pega el JSON aqu√≠..."></textarea>
                    </div>
                    
                    <div id="importPreview" class="import-preview" style="display: none;">
                        <div style="color: #64748b; font-size: 11px; margin-bottom: 8px; text-transform: uppercase; font-weight: 600;">Vista previa:</div>
                        <div id="previewContent"></div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-primary" onclick="previewImport()" style="flex: 1;">üëÅÔ∏è Vista Previa</button>
                        <button class="btn-success" onclick="importData()" style="flex: 1;">üì• Importar</button>
                        <button class="btn-secondary" onclick="exportData()" style="flex: 1;">üì§ Exportar</button>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155;">
                        <h4 style="margin-bottom: 15px; color: #64748b; font-size: 12px; text-transform: uppercase;">O Arrastra un Archivo JSON</h4>
                        <div id="dropZone" style="border: 2px dashed #334155; padding: 30px; text-align: center; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                            <div style="color: #64748b; font-size: 14px;">üìÑ Arrastra JSON aqu√≠</div>
                        </div>
                    </div>
                </div>
                
                <!-- INSPECT PANEL -->
                <div id="inspect" class="panel">
                    <h3 style="margin-bottom: 20px;">üîç Inspector de Base de Datos</h3>
                    <button class="btn-primary" onclick="inspectDatabase()" style="margin-bottom: 20px; padding: 10px 16px;">üìä Inspecci√≥n R√°pida</button>
                    <button class="btn-secondary" onclick="deepInspectDatabase()" style="margin-bottom: 20px; padding: 10px 16px; margin-left: 10px;">üî¨ Inspecci√≥n Profunda</button>
                    <div id="inspectResults"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('addCategoryModal')">&times;</span>
                ‚ûï Nueva Categor√≠a
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="catName" placeholder="Ej: Objetos, Animales...">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="submitAddCategory()" style="flex: 1;">Crear</button>
                <button class="btn-secondary" onclick="closeModal('addCategoryModal')" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="addPromptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('addPromptModal')">&times;</span>
                ‚ûï Nueva Consigna
            </div>
            <div class="alert alert-warning">
                ‚ö†Ô∏è Selecciona una categor√≠a primero en el panel izquierdo
            </div>
            <div class="form-group">
                <label>Texto:</label>
                <input type="text" id="promptText" placeholder="Ej: Cosas que encuentras en la cocina">
            </div>
            <div class="form-group">
                <label>Dificultad (1-5):</label>
                <input type="number" id="promptDifficulty" min="1" max="5" value="1">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="submitAddPrompt()" style="flex: 1;">Crear</button>
                <button class="btn-secondary" onclick="closeModal('addPromptModal')" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="addWordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('addWordModal')">&times;</span>
                ‚ûï Nueva Palabra
            </div>
            <div class="alert alert-warning">
                ‚ö†Ô∏è Selecciona una consigna primero en el panel central
            </div>
            <div class="form-group">
                <label>Palabra (puedes usar | para sin√≥nimos):</label>
                <input type="text" id="wordInput" placeholder="Ej: Flores|Ramo|Rosas">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="submitAddWord()" style="flex: 1;">Crear</button>
                <button class="btn-secondary" onclick="closeModal('addWordModal')" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('deleteConfirmModal')">&times;</span>
                ‚ö†Ô∏è Confirmar eliminaci√≥n
            </div>
            <div style="margin-bottom: 20px; color: #e2e8f0;">
                <p id="deleteConfirmText" style="margin: 0;"></p>
            </div>
            <div class="button-group">
                <button class="btn-danger" onclick="executeDelete()" style="flex: 1;">üóëÔ∏è Eliminar</button>
                <button class="btn-secondary" onclick="closeModal('deleteConfirmModal')" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script>
        const API = 'api.php';
        let selectedCategory = null;
        let selectedPrompt = null;
        let selectedBatchCategory = null;
        let selectedBatchPrompt = null;
        let allPrompts = [];
        let allWords = [];
        let lastImportPreview = null;
        let draggedElement = null;
        let draggedData = null;
        let pendingDelete = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            setupDropZone();
            loadDictionary();
            updateStats();
            setInterval(updateStats, 5000);
        });
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const btn = document.querySelector('.sidebar-toggle');
            sidebar.classList.toggle('collapsed');
            btn.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        }
        
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    
                    item.classList.add('active');
                    const panelId = item.getAttribute('data-panel');
                    document.getElementById(panelId).classList.add('active');
                    
                    const titles = {
                        'dictionary': 'üìö Gestor Cascada',
                        'batch-words': 'üìã Lote de Palabras',
                        'tools': '‚öôÔ∏è Herramientas',
                        'import-export': 'üì§ Import/Export',
                        'inspect': 'üîç Inspector'
                    };
                    
                    document.getElementById('pageTitle').textContent = titles[panelId] || panelId;
                    
                    if (panelId === 'batch-words') loadBatchPanel();
                });
            });
        }
        
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = '#1e40af';
                dropZone.style.borderColor = '#3b82f6';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.background = 'transparent';
                dropZone.style.borderColor = '#334155';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = 'transparent';
                dropZone.style.borderColor = '#334155';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        document.getElementById('importData').value = evt.target.result;
                        showMessage('‚úì Archivo cargado', 'success');
                    };
                    reader.readAsText(file);
                }
            });
        }
        
        function enableCategoryDragAndDrop() {
            const items = document.querySelectorAll('#categoriesList .cascade-item');
            items.forEach(item => {
                item.draggable = true;
                item.addEventListener('dragstart', handleCategoryDragStart);
                item.addEventListener('dragend', handleCategoryDragEnd);
                item.addEventListener('dragover', handleCategoryDragOver);
                item.addEventListener('drop', handleCategoryDrop);
                item.addEventListener('dragenter', handleCategoryDragEnter);
                item.addEventListener('dragleave', handleCategoryDragLeave);
            });
        }
        
        function handleCategoryDragStart(e) {
            draggedElement = this;
            draggedData = {
                id: this.getAttribute('data-category-id'),
                text: this.textContent.trim()
            };
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleCategoryDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('#categoriesList .cascade-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedElement = null;
            draggedData = null;
        }
        
        function handleCategoryDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleCategoryDragEnter(e) {
            if (this !== draggedElement && this.classList.contains('cascade-item')) {
                this.classList.add('drag-over');
            }
        }
        
        function handleCategoryDragLeave(e) {
            if (e.target === this) {
                this.classList.remove('drag-over');
            }
        }
        
        function handleCategoryDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            if (this !== draggedElement && draggedData) {
                const list = document.getElementById('categoriesList');
                const allItems = Array.from(list.querySelectorAll('.cascade-item'));
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(this);
                
                if (draggedIndex !== targetIndex) {
                    if (draggedIndex < targetIndex) {
                        this.parentNode.insertBefore(draggedElement, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedElement, this);
                    }
                    
                    reorderCategoriesInDatabase();
                }
            }
            
            this.classList.remove('drag-over');
            return false;
        }
        
        function reorderCategoriesInDatabase() {
            const items = document.querySelectorAll('#categoriesList .cascade-item');
            const order = Array.from(items).map(item => parseInt(item.getAttribute('data-category-id')));
            
            fetch(`${API}?action=reorder-categories`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ order: order })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showMessage('‚úì Categor√≠as reordenadas', 'success');
                    loadDictionary();
                } else {
                    showMessage('Error: ' + data.message, 'error');
                    loadDictionary();
                }
            })
            .catch(err => {
                showMessage('Error reordenando: ' + err.message, 'error');
                loadDictionary();
            });
        }
        
        async function loadDictionary() {
            try {
                const [categoriesRes, promptsRes, wordsRes] = await Promise.all([
                    fetch(`${API}?action=get-categories`),
                    fetch(`${API}?action=get-prompts`),
                    fetch(`${API}?action=get-words`)
                ]);
                
                const categories = await categoriesRes.json().then(r => r.data || []);
                const prompts = await promptsRes.json().then(r => r.data || []);
                const words = await wordsRes.json().then(r => r.data || []);
                
                allPrompts = prompts;
                allWords = words;
                
                renderCategories(categories);
                
                if (selectedCategory) {
                    const filtered = prompts.filter(p => p.category_ids.includes(selectedCategory));
                    renderPrompts(filtered);
                    
                    if (selectedPrompt) {
                        const wordFiltered = words.filter(w => w.prompt_id === selectedPrompt);
                        renderWords(wordFiltered);
                    }
                }
            } catch (error) {
                showMessage('Error cargando: ' + error.message, 'error');
            }
        }
        
        async function loadBatchPanel() {
            try {
                const [categoriesRes, promptsRes, wordsRes] = await Promise.all([
                    fetch(`${API}?action=get-categories`),
                    fetch(`${API}?action=get-prompts`),
                    fetch(`${API}?action=get-words`)
                ]);
                
                const categories = await categoriesRes.json().then(r => r.data || []);
                const prompts = await promptsRes.json().then(r => r.data || []);
                const words = await wordsRes.json().then(r => r.data || []);
                
                allPrompts = prompts;
                allWords = words;
                
                renderBatchCategories(categories);
            } catch (error) {
                showMessage('Error cargando: ' + error.message, 'error');
            }
        }
        
        function countPromptsForCategory(categoryId) {
            return allPrompts.filter(p => p.category_ids.includes(categoryId)).length;
        }
        
        function renderBatchCategories(categories) {
            const list = document.getElementById('batchCategoriesList');
            if (!categories || categories.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Sin categor√≠as</div>';
                return;
            }
            
            list.innerHTML = categories
                .sort((a, b) => a.orden - b.orden)
                .map(cat => `
                    <div class="batch-list-item ${selectedBatchCategory === cat.id ? 'selected' : ''}" onclick="selectBatchCategory(${cat.id})">
                        <span>${cat.name}</span>
                    </div>
                `).join('');
        }
        
        function selectBatchCategory(catId) {
            selectedBatchCategory = catId;
            selectedBatchPrompt = null;
            document.getElementById('batchWordsInput').value = '';
            document.getElementById('batchCatInfo').textContent = `${catId}. Seleccionada`;
            
            const prompts = allPrompts.filter(p => p.category_ids.includes(catId));
            renderBatchPrompts(prompts);
        }
        
        function renderBatchPrompts(prompts) {
            const list = document.getElementById('batchPromptsList');
            if (!prompts || prompts.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Selecciona categor√≠a</div>';
                return;
            }
            
            list.innerHTML = prompts
                .sort((a, b) => a.text.localeCompare(b.text))
                .map(p => `
                    <div class="batch-list-item ${selectedBatchPrompt === p.id ? 'selected' : ''}" onclick="selectBatchPrompt(${p.id})">
                        <span>${p.text}</span>
                    </div>
                `).join('');
        }
        
        function selectBatchPrompt(promptId) {
            selectedBatchPrompt = promptId;
            const prompt = allPrompts.find(p => p.id === promptId);
            document.getElementById('batchPromptInfo').textContent = prompt ? prompt.text : '-- Selecciona --';
        }
        
        async function loadBatchWords() {
            if (!selectedBatchPrompt) {
                showMessage('Selecciona una consigna primero', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API}?action=get-words&prompt_id=${selectedBatchPrompt}`);
                const json = await response.json();
                const words = json.data || [];
                
                const wordGroups = words
                    .filter(w => w && w.word_group)
                    .map(w => w.word_group);
                
                document.getElementById('batchWordsInput').value = wordGroups.join('\n');
                showMessage(`‚úì ${wordGroups.length} palabras cargadas`, 'success');
            } catch (error) {
                showMessage('Error cargando palabras: ' + error.message, 'error');
            }
        }
        
        async function replaceBatchWords() {
            if (!selectedBatchPrompt) {
                showMessage('Selecciona una consigna primero', 'error');
                return;
            }
            
            const inputText = document.getElementById('batchWordsInput').value.trim();
            if (inputText.length === 0) {
                showMessage('Ingresa palabras', 'error');
                return;
            }
            
            const newWords = inputText.split('\n').map(w => w.trim()).filter(w => w.length > 0);
            
            if (newWords.length === 0) {
                showMessage('Ingresa palabras v√°lidas', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API}?action=replace-prompt-words`, {
                    method: 'POST',
                    body: JSON.stringify({ prompt_id: selectedBatchPrompt, words: newWords }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`‚úì ${result.data.added} palabras actualizadas`, 'success');
                    loadBatchPanel();
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        function renderCategories(categories) {
            const list = document.getElementById('categoriesList');
            if (!categories || categories.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Sin categor√≠as</div>';
                return;
            }
            
            list.innerHTML = categories
                .sort((a, b) => a.orden - b.orden)
                .map(cat => {
                    const promptCount = countPromptsForCategory(cat.id);
                    return `
                        <div class="cascade-item ${selectedCategory === cat.id ? 'selected' : ''}" 
                             data-category-id="${cat.id}" 
                             onclick="selectCategory(${cat.id})">
                            <div class="cascade-item-content">
                                <span>${cat.name}</span>
                                <span class="cascade-item-badge">${promptCount}</span>
                            </div>
                            <button class="cascade-item-btn-delete" onclick="event.stopPropagation(); confirmDelete('category', ${cat.id}, '${cat.name}')" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    `;
                }).join('');
            
            enableCategoryDragAndDrop();
        }
        
        function renderPrompts(prompts) {
            const list = document.getElementById('promptsList');
            if (!prompts || prompts.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Selecciona categor√≠a</div>';
                return;
            }
            
            list.innerHTML = prompts
                .sort((a, b) => a.text.localeCompare(b.text))
                .map(p => `
                    <div class="cascade-item ${selectedPrompt === p.id ? 'selected' : ''}" onclick="selectPrompt(${p.id})">
                        <div class="cascade-item-content">
                            <span style="flex: 1;">${p.text}</span>
                            <span class="cascade-item-badge">‚≠ê${p.difficulty}</span>
                        </div>
                        <button class="cascade-item-btn-delete" onclick="event.stopPropagation(); confirmDelete('prompt', ${p.id}, '${p.text}')" title="Eliminar">üóëÔ∏è</button>
                    </div>
                `).join('');
        }
        
        function renderWords(words) {
            const list = document.getElementById('wordsList');
            if (!words || words.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Selecciona consigna</div>';
                return;
            }
            
            list.innerHTML = words
                .filter(w => w && w.word_group)
                .sort((a, b) => (a.word_group || '').localeCompare(b.word_group || ''))
                .map(w => `
                    <div class="cascade-item">
                        <div class="cascade-item-content">
                            <span>${w.word_group}</span>
                        </div>
                        <button class="cascade-item-btn-delete" onclick="event.stopPropagation(); confirmDelete('word', ${w.id}, '${w.word_group}')" title="Eliminar">üóëÔ∏è</button>
                    </div>
                `).join('');
        }
        
        function selectCategory(catId) {
            selectedCategory = catId;
            selectedPrompt = null;
            loadDictionary();
        }
        
        async function selectPrompt(promptId) {
            selectedPrompt = promptId;
            const response = await fetch(`${API}?action=get-words&prompt_id=${promptId}`);
            const json = await response.json();
            renderWords(json.data || []);
        }
        
        function confirmDelete(type, id, name) {
            let message = '';
            
            if (type === 'category') {
                message = `¬øEliminar categor√≠a "${name}"? Se eliminar√°n todas las consignas y palabras asociadas.`;
            } else if (type === 'prompt') {
                message = `¬øEliminar consigna "${name}"? Se eliminar√°n todas las palabras asociadas.`;
            } else if (type === 'word') {
                message = `¬øEliminar palabra "${name}"?`;
            }
            
            pendingDelete = { type, id, name };
            document.getElementById('deleteConfirmText').textContent = message;
            openModal('deleteConfirmModal');
        }
        
        async function executeDelete() {
            if (!pendingDelete) return;
            
            const { type, id } = pendingDelete;
            closeModal('deleteConfirmModal');
            
            let action = '';
            if (type === 'category') action = 'delete-category';
            else if (type === 'prompt') action = 'delete-prompt';
            else if (type === 'word') action = 'delete-word';
            
            try {
                const response = await fetch(`${API}?action=${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`‚úì ${type === 'category' ? 'Categor√≠a' : type === 'prompt' ? 'Consigna' : 'Palabra'} eliminada`, 'success');
                    
                    if (type === 'category') {
                        selectedCategory = null;
                        selectedPrompt = null;
                    } else if (type === 'prompt') {
                        selectedPrompt = null;
                    }
                    
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
            
            pendingDelete = null;
        }
        
        async function updateStats() {
            try {
                const response = await fetch(`${API}?action=get-stats`);
                const res = await response.json();
                if (res.success && res.data) {
                    document.getElementById('catCount').textContent = res.data.categories;
                    document.getElementById('promptCount').textContent = res.data.prompts;
                    document.getElementById('wordCount').textContent = res.data.words;
                }
            } catch (error) {
                console.error('Stats update failed:', error);
            }
        }
        
        async function submitAddCategory() {
            const name = document.getElementById('catName').value.trim();
            if (!name) {
                showMessage('Nombre requerido', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API}?action=add-category`, {
                    method: 'POST',
                    body: JSON.stringify({ name }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const res = await response.json();
                
                if (res.success) {
                    showMessage('‚úì Categor√≠a creada', 'success');
                    document.getElementById('catName').value = '';
                    closeModal('addCategoryModal');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function submitAddPrompt() {
            if (!selectedCategory) {
                showMessage('Selecciona categor√≠a primero', 'error');
                return;
            }
            
            const text = document.getElementById('promptText').value.trim();
            const difficulty = parseInt(document.getElementById('promptDifficulty').value);
            
            if (!text) {
                showMessage('Texto requerido', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API}?action=add-prompt`, {
                    method: 'POST',
                    body: JSON.stringify({ text, category_ids: [selectedCategory], difficulty }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const res = await response.json();
                
                if (res.success) {
                    showMessage('‚úì Consigna creada', 'success');
                    document.getElementById('promptText').value = '';
                    closeModal('addPromptModal');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function submitAddWord() {
            if (!selectedPrompt) {
                showMessage('Selecciona consigna primero', 'error');
                return;
            }
            
            const word = document.getElementById('wordInput').value.trim();
            
            if (!word) {
                showMessage('Palabra requerida', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API}?action=add-word`, {
                    method: 'POST',
                    body: JSON.stringify({ prompt_id: selectedPrompt, word }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const res = await response.json();
                
                if (res.success) {
                    showMessage('‚úì Palabra agregada', 'success');
                    document.getElementById('wordInput').value = '';
                    closeModal('addWordModal');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function optimizeDatabase() {
            try {
                const response = await fetch(`${API}?action=optimize`, { method: 'POST' });
                const res = await response.json();
                showMessage(res.success ? '‚úì BD optimizada' : 'Error: ' + res.message, res.success ? 'success' : 'error');
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function runDiagnostic() {
            try {
                const response = await fetch(`${API}?action=inspect`);
                const res = await response.json();
                if (res.success) {
                    showMessage('‚úì Diagn√≥stico completado', 'success');
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        function previewImport() {
            const data = document.getElementById('importData').value.trim();
            if (!data) {
                showMessage('Pega JSON primero', 'error');
                return;
            }
            
            try {
                const json = JSON.parse(data);
                lastImportPreview = json;
                
                let html = '';
                let catCount = 0, promptCount = 0, wordCount = 0;
                
                if (json.categories && json.prompts) {
                    catCount = json.categories.length;
                    promptCount = json.prompts.length;
                    wordCount = json.prompts.reduce((sum, p) => sum + (p.words?.length || 0), 0);
                } else {
                    for (const [catName, catData] of Object.entries(json)) {
                        catCount++;
                        if (Array.isArray(catData)) {
                            catData.forEach(item => {
                                Object.keys(item).forEach(promptText => {
                                    promptCount++;
                                    const words = item[promptText];
                                    if (Array.isArray(words)) {
                                        wordCount += words.filter(w => typeof w === 'string').length;
                                    }
                                });
                            });
                        }
                    }
                }
                
                html += `<div class="preview-item">üìÅ Categor√≠as: <strong>${catCount}</strong></div>`;
                html += `<div class="preview-item">üí¨ Consignas: <strong>${promptCount}</strong></div>`;
                html += `<div class="preview-item">üìù Palabras: <strong>${wordCount}</strong></div>`;
                
                document.getElementById('previewContent').innerHTML = html;
                document.getElementById('importPreview').style.display = 'block';
                showMessage('‚úì Vista previa generada', 'info');
            } catch (error) {
                showMessage('JSON inv√°lido: ' + error.message, 'error');
                document.getElementById('importPreview').style.display = 'none';
            }
        }
        
        async function importData() {
            const data = document.getElementById('importData').value.trim();
            if (!data) {
                showMessage('Pega JSON primero', 'error');
                return;
            }
            
            try {
                const json = JSON.parse(data);
                const response = await fetch(`${API}?action=import`, {
                    method: 'POST',
                    body: JSON.stringify(json),
                    headers: { 'Content-Type': 'application/json' }
                });
                const res = await response.json();
                
                if (res.success) {
                    const stats = res.data;
                    showMessage(`‚úì Importado [${stats.format}]: ${stats.categories_added} categor√≠as, ${stats.prompts_added} consignas, ${stats.words_added} palabras`, 'success');
                    document.getElementById('importData').value = '';
                    document.getElementById('importPreview').style.display = 'none';
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('JSON inv√°lido: ' + error.message, 'error');
            }
        }
        
        async function exportData() {
            try {
                const [categoriesRes, promptsRes, allWordsRes] = await Promise.all([
                    fetch(`${API}?action=get-categories`),
                    fetch(`${API}?action=get-prompts`),
                    fetch(`${API}?action=get-words`)
                ]);
                
                const categories = await categoriesRes.json().then(r => r.data || []);
                const prompts = await promptsRes.json().then(r => r.data || []);
                const allWordsData = await allWordsRes.json().then(r => r.data || []);
                
                const data = {
                    categories: categories,
                    prompts: prompts.map(p => ({
                        id: p.id,
                        text: p.text,
                        difficulty: p.difficulty,
                        category_ids: p.category_ids,
                        words: allWordsData.filter(w => w.prompt_id === p.id).map(w => w.word_group)
                    })),
                    timestamp: new Date().toISOString()
                };
                
                document.getElementById('importData').value = JSON.stringify(data, null, 2);
                showMessage('‚úì Datos exportados', 'success');
            } catch (error) {
                showMessage('Error exportando: ' + error.message, 'error');
            }
        }
        
        async function inspectDatabase() {
            try {
                const response = await fetch(`${API}?action=inspect`);
                const res = await response.json();
                if (res.success) {
                    const data = res.data;
                    let html = `<div class="table-container">
                        <table>
                            <tr><td colspan="2" style="background: #0f172a; font-weight: 600; padding: 15px;">üìä ESTAD√çSTICAS GENERALES</td></tr>
                            <tr><td>Categor√≠as</td><td><strong>${data.stats.categories}</strong></td></tr>
                            <tr><td>Consignas</td><td><strong>${data.stats.prompts}</strong></td></tr>
                            <tr><td>Palabras V√°lidas</td><td><strong>${data.stats.words}</strong></td></tr>
                            <tr><td>Partidas</td><td><strong>${data.stats.games}</strong></td></tr>
                            <tr><td>Jugadores</td><td><strong>${data.stats.players}</strong></td></tr>
                            <tr><td>Tama√±o BD</td><td><strong>${(data.dictionary_size / 1024).toFixed(2)} KB</strong></td></tr>
                        </table>
                    </div>`;
                    document.getElementById('inspectResults').innerHTML = html;
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function deepInspectDatabase() {
            try {
                const response = await fetch(`${API}?action=deep-inspect`);
                const res = await response.json();
                if (res.success) {
                    const data = res.data;
                    let html = `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #3b82f6; margin-bottom: 10px;">üìÑ Archivo: ${data.database_file}</h4>
                            <span class="schema-stat">üìä ${data.file_size_mb} MB</span>
                            <span class="schema-stat">‚è∞ ${data.timestamp}</span>
                            <span class="schema-stat">üìã ${data.total_tables} tablas</span>
                        </div>
                    `;
                    
                    for (const [tableName, tableInfo] of Object.entries(data.tables)) {
                        html += `<div class="schema-table">
                            <div class="schema-table-name">üìä ${tableName} (${tableInfo.row_count} filas)</div>
                            <div class="schema-table-content">`;
                        
                        if (tableInfo.columns) {
                            html += `<div class="schema-section">
                                <div class="schema-section-title">Columnas</div>`;
                            for (const col of tableInfo.columns) {
                                let colInfo = `${col.name}: <strong>${col.type}</strong>`;
                                if (col.pk) colInfo += ` <span style="color: #ec4899;">[PK]</span>`;
                                if (col.notnull) colInfo += ` <span style="color: #f59e0b;">[NOT NULL]</span>`;
                                if (col.default) colInfo += ` <span style="color: #8b5cf6;">[DEFAULT: ${col.default}]</span>`;
                                html += `<div class="schema-item">${colInfo}</div>`;
                            }
                            html += `</div>`;
                        }
                        
                        if (tableInfo.indexes && tableInfo.indexes.length > 0) {
                            html += `<div class="schema-section">
                                <div class="schema-section-title">√çndices</div>`;
                            for (const idx of tableInfo.indexes) {
                                html += `<div class="schema-item">üìã ${idx.name}${idx.unique ? ' [UNIQUE]' : ''}: (${idx.columns.join(', ')})</div>`;
                            }
                            html += `</div>`;
                        }
                        
                        if (tableInfo.foreign_keys && tableInfo.foreign_keys.length > 0) {
                            html += `<div class="schema-section">
                                <div class="schema-section-title">Foreign Keys</div>`;
                            for (const fk of tableInfo.foreign_keys) {
                                html += `<div class="schema-item">üîó ${fk.column} ‚Üí ${fk.references_table}(${fk.references_column})</div>`;
                            }
                            html += `</div>`;
                        }
                        
                        html += `</div></div>`;
                    }
                    
                    document.getElementById('inspectResults').innerHTML = html;
                    showMessage('‚úì Inspecci√≥n profunda completada', 'success');
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showMessage(msg, type = 'success') {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = 'message ' + type;
            setTimeout(() => el.className = 'message', 5000);
        }
    </script>
</body>
</html>