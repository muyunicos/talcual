<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalCual - Database Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100%;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
        }
        
        .sidebar-header h1 {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .nav-section-title {
            padding: 12px 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #475569;
            letter-spacing: 0.8px;
            margin-top: 15px;
        }
        
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .nav-item:hover {
            background: #334155;
        }
        
        .nav-item.active {
            background: #1e40af;
            border-left-color: #3b82f6;
            color: #fff;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            padding: 20px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
        }
        
        .stat-label {
            color: #64748b;
            margin-top: 2px;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
        }
        
        .cascading-view {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            height: 100%;
        }
        
        .cascade-pane {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .cascade-header {
            padding: 15px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: #64748b;
        }
        
        .cascade-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .cascade-item {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cascade-item:hover {
            background: #334155;
        }
        
        .cascade-item.selected {
            background: #1e40af;
            color: #fff;
            border-left: 3px solid #3b82f6;
            padding-left: 12px;
        }
        
        .cascade-item-badge {
            background: #334155;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .cascade-item.selected .cascade-item-badge {
            background: #3b82f6;
        }
        
        .cascade-empty {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #e2e8f0;
            font-family: inherit;
            font-size: 13px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            background: #0f172a;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #475569;
            color: #fff;
        }
        
        .btn-secondary:hover {
            background: #64748b;
        }
        
        .btn-danger {
            background: #dc2626;
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-success {
            background: #059669;
            color: #fff;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .message {
            padding: 12px 15px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.success {
            background: #064e3b;
            color: #86efac;
            border: 1px solid #059669;
            display: block;
        }
        
        .message.error {
            background: #7f1d1d;
            color: #fca5a5;
            border: 1px solid #dc2626;
            display: block;
        }
        
        .table-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            background: #0f172a;
            border-bottom: 2px solid #334155;
        }
        
        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            font-size: 11px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
        }
        
        tbody tr:hover {
            background: #334155;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #e2e8f0;
        }
        
        .modal-close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        
        .modal-close:hover {
            color: #e2e8f0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-warning {
            background: #78350f;
            border: 1px solid #b45309;
            color: #fde047;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>TalCual Admin</h1>
            </div>
            
            <div class="nav-section-title">Diccionario</div>
            <div class="nav-item active" data-panel="dictionary">üìö Gestor Cascada</div>
            <div class="nav-item" data-panel="batch-words">üìã Lote de Palabras</div>
            
            <div class="nav-section-title">Herramientas</div>
            <div class="nav-item" data-panel="tools">‚öôÔ∏è Optimizaci√≥n</div>
            <div class="nav-item" data-panel="import-export">üì§ Import/Export</div>
            <div class="nav-item" data-panel="inspect">üîç Inspector</div>
        </div>
        
        <div class="main">
            <div class="header">
                <h2 id="pageTitle">üìö Gestor de Diccionario</h2>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="catCount">0</div>
                        <div class="stat-label">Categor√≠as</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="promptCount">0</div>
                        <div class="stat-label">Consignas</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="wordCount">0</div>
                        <div class="stat-label">Palabras</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div id="message" class="message"></div>
                
                <!-- DICTIONARY PANEL -->
                <div id="dictionary" class="panel active">
                    <div class="cascading-view">
                        <!-- Categories Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">üìÅ Categor√≠as</div>
                            <div class="cascade-list" id="categoriesList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%;" onclick="openModal('addCategoryModal')">+ Nueva</button>
                            </div>
                        </div>
                        
                        <!-- Prompts Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">üí¨ Consignas</div>
                            <div class="cascade-list" id="promptsList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%;" onclick="openModal('addPromptModal')">+ Nueva</button>
                            </div>
                        </div>
                        
                        <!-- Words Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">üìù Palabras</div>
                            <div class="cascade-list" id="wordsList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%;" onclick="openModal('addWordModal')">+ Nueva</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BATCH WORDS PANEL -->
                <div id="batch-words" class="panel">
                    <h3 style="margin-bottom: 20px;">üìã Agregar Palabras por Lote</h3>
                    <div class="form-group">
                        <label>Selecciona Consigna:</label>
                        <select id="batchPromptSelect" style="width: 100%; padding: 10px;">
                            <option value="">-- Cargando --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Palabras (una por l√≠nea):</label>
                        <textarea id="batchWordsInput" placeholder="PALABRA1\nPALABRA2\nPALABRA3"></textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn-primary" onclick="addBatchWords()" style="flex: 1;">‚úì Agregar Lote</button>
                    </div>
                </div>
                
                <!-- TOOLS PANEL -->
                <div id="tools" class="panel">
                    <h3 style="margin-bottom: 20px;">‚öôÔ∏è Herramientas de Optimizaci√≥n</h3>
                    
                    <div class="form-group">
                        <button class="btn-success" onclick="optimizeDatabase()" style="width: 100%; padding: 12px;">üîß Optimizar Base de Datos</button>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn-secondary" onclick="runDiagnostic()" style="width: 100%; padding: 12px;">üîç Ejecutar Diagn√≥stico</button>
                    </div>
                </div>
                
                <!-- IMPORT/EXPORT PANEL -->
                <div id="import-export" class="panel">
                    <h3 style="margin-bottom: 20px;">üì§ Importar / Exportar</h3>
                    
                    <div class="form-group">
                        <label>Importar JSON:</label>
                        <textarea id="importData" placeholder="Pega JSON aqu√≠..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-primary" onclick="importData()" style="flex: 1;">üì• Importar</button>
                        <button class="btn-secondary" onclick="exportData()" style="flex: 1;">üì§ Exportar</button>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155;">
                        <h4 style="margin-bottom: 15px; color: #64748b; font-size: 12px; text-transform: uppercase;">O Arrastra un Archivo JSON</h4>
                        <div id="dropZone" style="border: 2px dashed #334155; padding: 30px; text-align: center; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                            <div style="color: #64748b; font-size: 14px;">üìÅ Arrastra JSON aqu√≠</div>
                        </div>
                    </div>
                </div>
                
                <!-- INSPECT PANEL -->
                <div id="inspect" class="panel">
                    <h3 style="margin-bottom: 20px;">üîç Inspector de Base de Datos</h3>
                    <button class="btn-primary" onclick="inspectDatabase()" style="margin-bottom: 20px; padding: 10px 16px;">üîç Inspeccionar</button>
                    <div id="inspectResults"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('addCategoryModal')">&times;</span>
                ‚ûï Nueva Categor√≠a
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="catName" placeholder="Ej: Objetos, Animales...">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="submitAddCategory()" style="flex: 1;">Crear</button>
                <button class="btn-secondary" onclick="closeModal('addCategoryModal')" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="addPromptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('addPromptModal')">&times;</span>
                ‚ûï Nueva Consigna
            </div>
            <div class="alert alert-warning">
                ‚ö†Ô∏è Selecciona una categor√≠a primero en el panel izquierdo
            </div>
            <div class="form-group">
                <label>Texto:</label>
                <input type="text" id="promptText" placeholder="Ej: Cosas que encuentras en la cocina">
            </div>
            <div class="form-group">
                <label>Dificultad (1-5):</label>
                <input type="number" id="promptDifficulty" min="1" max="5" value="1">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="submitAddPrompt()" style="flex: 1;">Crear</button>
                <button class="btn-secondary" onclick="closeModal('addPromptModal')" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="addWordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('addWordModal')">&times;</span>
                ‚ûï Nueva Palabra
            </div>
            <div class="alert alert-warning">
                ‚ö†Ô∏è Selecciona una consigna primero en el panel central
            </div>
            <div class="form-group">
                <label>Palabra:</label>
                <input type="text" id="wordInput" placeholder="Ej: CUCHARA">
            </div>
            <div class="form-group">
                <label>G√©nero (opcional):</label>
                <select id="genderSelect">
                    <option value="">Sin especificar</option>
                    <option value="m">Masculino (m)</option>
                    <option value="f">Femenino (f)</option>
                    <option value="n">Neutro (n)</option>
                </select>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="submitAddWord()" style="flex: 1;">Crear</button>
                <button class="btn-secondary" onclick="closeModal('addWordModal')" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script>
        const API = 'api.php';
        let selectedCategory = null;
        let selectedPrompt = null;
        let allPrompts = [];
        let allWords = [];
        
        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            setupDropZone();
            loadDictionary();
            updateStats();
            setInterval(updateStats, 5000);
        });
        
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    
                    item.classList.add('active');
                    const panelId = item.getAttribute('data-panel');
                    document.getElementById(panelId).classList.add('active');
                    
                    const titles = {
                        'dictionary': 'üìö Gestor Cascada',
                        'batch-words': 'üìã Lote de Palabras',
                        'tools': '‚öôÔ∏è Herramientas',
                        'import-export': 'üì§ Import/Export',
                        'inspect': 'üîç Inspector'
                    };
                    
                    document.getElementById('pageTitle').textContent = titles[panelId] || panelId;
                    
                    if (panelId === 'batch-words') loadBatchWordsSelect();
                });
            });
        }
        
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = '#1e40af';
                dropZone.style.borderColor = '#3b82f6';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.background = 'transparent';
                dropZone.style.borderColor = '#334155';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = 'transparent';
                dropZone.style.borderColor = '#334155';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        document.getElementById('importData').value = evt.target.result;
                        showMessage('‚úì Archivo cargado', 'success');
                    };
                    reader.readAsText(file);
                }
            });
        }
        
        async function loadDictionary() {
            try {
                const [categories, prompts, words] = await Promise.all([
                    fetch(`${API}?action=get-categories`).then(r => r.json()).then(r => r.data || []),
                    fetch(`${API}?action=get-prompts`).then(r => r.json()).then(r => r.data || []),
                    fetch(`${API}?action=get-words`).then(r => r.json()).then(r => r.data || [])
                ]);
                
                allPrompts = prompts;
                allWords = words;
                
                renderCategories(categories);
                
                if (selectedCategory) {
                    const filtered = prompts.filter(p => p.category_ids.includes(selectedCategory));
                    renderPrompts(filtered);
                    
                    if (selectedPrompt) {
                        const wordFiltered = words.filter(w => w.prompt_id === selectedPrompt);
                        renderWords(wordFiltered);
                    }
                }
            } catch (error) {
                showMessage('Error cargando: ' + error.message, 'error');
            }
        }
        
        function renderCategories(categories) {
            const list = document.getElementById('categoriesList');
            if (!categories || categories.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Sin categor√≠as</div>';
                return;
            }
            
            list.innerHTML = categories
                .sort((a, b) => a.orden - b.orden)
                .map(cat => `
                    <div class="cascade-item ${selectedCategory === cat.id ? 'selected' : ''}" onclick="selectCategory(${cat.id})">
                        <span>${cat.name}</span>
                        <span class="cascade-item-badge">#${cat.id}</span>
                    </div>
                `).join('');
        }
        
        function renderPrompts(prompts) {
            const list = document.getElementById('promptsList');
            if (!prompts || prompts.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Selecciona categor√≠a</div>';
                return;
            }
            
            list.innerHTML = prompts
                .sort((a, b) => a.text.localeCompare(b.text))
                .map(p => `
                    <div class="cascade-item ${selectedPrompt === p.id ? 'selected' : ''}" onclick="selectPrompt(${p.id})">
                        <span style="flex: 1;">${p.text}</span>
                        <span class="cascade-item-badge">‚≠ê${p.difficulty}</span>
                    </div>
                `).join('');
        }
        
        function renderWords(words) {
            const list = document.getElementById('wordsList');
            if (!words || words.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Selecciona consigna</div>';
                return;
            }
            
            list.innerHTML = words
                .sort((a, b) => a.word.localeCompare(b.word))
                .map(w => `
                    <div class="cascade-item">
                        <span>${w.word}</span>
                        <span class="cascade-item-badge">${w.gender || '?'}</span>
                    </div>
                `).join('');
        }
        
        function selectCategory(catId) {
            selectedCategory = catId;
            selectedPrompt = null;
            loadDictionary();
        }
        
        async function selectPrompt(promptId) {
            selectedPrompt = promptId;
            const words = await fetch(`${API}?action=get-words&prompt_id=${promptId}`).then(r => r.json()).then(r => r.data || []);
            renderWords(words);
        }
        
        async function updateStats() {
            try {
                const res = await fetch(`${API}?action=get-stats`).then(r => r.json());
                if (res.success && res.data) {
                    document.getElementById('catCount').textContent = res.data.categories;
                    document.getElementById('promptCount').textContent = res.data.prompts;
                    document.getElementById('wordCount').textContent = res.data.words;
                }
            } catch (error) {
                console.error('Stats update failed:', error);
            }
        }
        
        async function submitAddCategory() {
            const name = document.getElementById('catName').value.trim();
            if (!name) {
                showMessage('Nombre requerido', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API}?action=add-category`, {
                    method: 'POST',
                    body: JSON.stringify({ name }),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage('‚úì Categor√≠a creada', 'success');
                    document.getElementById('catName').value = '';
                    closeModal('addCategoryModal');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function submitAddPrompt() {
            if (!selectedCategory) {
                showMessage('Selecciona categor√≠a primero', 'error');
                return;
            }
            
            const text = document.getElementById('promptText').value.trim();
            const difficulty = parseInt(document.getElementById('promptDifficulty').value);
            
            if (!text) {
                showMessage('Texto requerido', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API}?action=add-prompt`, {
                    method: 'POST',
                    body: JSON.stringify({ text, category_ids: [selectedCategory], difficulty }),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage('‚úì Consigna creada', 'success');
                    document.getElementById('promptText').value = '';
                    closeModal('addPromptModal');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function submitAddWord() {
            if (!selectedPrompt) {
                showMessage('Selecciona consigna primero', 'error');
                return;
            }
            
            const word = document.getElementById('wordInput').value.trim();
            const gender = document.getElementById('genderSelect').value || null;
            
            if (!word) {
                showMessage('Palabra requerida', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API}?action=add-word`, {
                    method: 'POST',
                    body: JSON.stringify({ prompt_id: selectedPrompt, word, gender }),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage('‚úì Palabra agregada', 'success');
                    document.getElementById('wordInput').value = '';
                    closeModal('addWordModal');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function loadBatchWordsSelect() {
            const select = document.getElementById('batchPromptSelect');
            const prompts = await fetch(`${API}?action=get-prompts`).then(r => r.json()).then(r => r.data || []);
            
            select.innerHTML = '<option value="">-- Selecciona Consigna --</option>' +
                prompts.map(p => `<option value="${p.id}">${p.text}</option>`).join('');
        }
        
        async function addBatchWords() {
            const promptId = document.getElementById('batchPromptSelect').value;
            const words = document.getElementById('batchWordsInput').value
                .split('\n')
                .map(w => w.trim())
                .filter(w => w.length > 0);
            
            if (!promptId) {
                showMessage('Selecciona consigna', 'error');
                return;
            }
            
            if (words.length === 0) {
                showMessage('Ingresa palabras', 'error');
                return;
            }
            
            let added = 0;
            for (const word of words) {
                try {
                    const res = await fetch(`${API}?action=add-word`, {
                        method: 'POST',
                        body: JSON.stringify({ prompt_id: parseInt(promptId), word }),
                        headers: { 'Content-Type': 'application/json' }
                    }).then(r => r.json());
                    
                    if (res.success) added++;
                } catch (e) {
                    console.error('Word error:', e);
                }
            }
            
            showMessage(`‚úì ${added} de ${words.length} palabras agregadas`, 'success');
            document.getElementById('batchWordsInput').value = '';
            loadDictionary();
            updateStats();
        }
        
        async function optimizeDatabase() {
            try {
                const res = await fetch(`${API}?action=optimize`, { method: 'POST' }).then(r => r.json());
                showMessage(res.success ? '‚úì BD optimizada' : 'Error: ' + res.message, res.success ? 'success' : 'error');
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function runDiagnostic() {
            try {
                const res = await fetch(`${API}?action=inspect`).then(r => r.json());
                if (res.success) {
                    const stats = res.data.stats;
                    showMessage('‚úì Diagn√≥stico completado', 'success');
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function importData() {
            const data = document.getElementById('importData').value.trim();
            if (!data) {
                showMessage('Pega JSON primero', 'error');
                return;
            }
            
            try {
                const json = JSON.parse(data);
                const res = await fetch(`${API}?action=import`, {
                    method: 'POST',
                    body: JSON.stringify(json),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    const stats = res.data;
                    showMessage(`‚úì Importado: ${stats.categories_added} categor√≠as, ${stats.prompts_added} consignas, ${stats.words_added} palabras`, 'success');
                    document.getElementById('importData').value = '';
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('JSON inv√°lido: ' + error.message, 'error');
            }
        }
        
        async function exportData() {
            try {
                const [categories, prompts] = await Promise.all([
                    fetch(`${API}?action=get-categories`).then(r => r.json()).then(r => r.data || []),
                    fetch(`${API}?action=get-prompts`).then(r => r.json()).then(r => r.data || [])
                ]);
                
                const allWords = await fetch(`${API}?action=get-words`).then(r => r.json()).then(r => r.data || []);
                
                const data = {
                    categories: categories,
                    prompts: prompts.map(p => ({
                        id: p.id,
                        text: p.text,
                        difficulty: p.difficulty,
                        category_ids: p.category_ids,
                        words: allWords.filter(w => w.prompt_id === p.id).map(w => w.word)
                    })),
                    timestamp: new Date().toISOString()
                };
                
                document.getElementById('importData').value = JSON.stringify(data, null, 2);
                showMessage('‚úì Datos exportados', 'success');
            } catch (error) {
                showMessage('Error exportando: ' + error.message, 'error');
            }
        }
        
        async function inspectDatabase() {
            try {
                const res = await fetch(`${API}?action=inspect`).then(r => r.json());
                if (res.success) {
                    const html = `<pre style="background: #1e293b; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 11px; line-height: 1.5;">${JSON.stringify(res.data, null, 2)}</pre>`;
                    document.getElementById('inspectResults').innerHTML = html;
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showMessage(msg, type = 'success') {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = 'message ' + type;
            setTimeout(() => el.className = 'message', 5000);
        }
    </script>
</body>
</html>
