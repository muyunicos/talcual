<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalCual - Database Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100%;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
        }
        
        .sidebar-header h1 {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .nav-section {
            padding: 0;
            margin: 0;
        }
        
        .nav-section-title {
            padding: 12px 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #475569;
            letter-spacing: 0.8px;
            margin-top: 15px;
        }
        
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .nav-item:hover {
            background: #334155;
        }
        
        .nav-item.active {
            background: #1e40af;
            border-left-color: #3b82f6;
            color: #fff;
        }
        
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            padding: 20px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
        }
        
        .stat-label {
            color: #64748b;
            margin-top: 2px;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
        }
        
        .cascading-view {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            height: 100%;
        }
        
        .cascade-pane {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .cascade-header {
            padding: 15px;
            border-bottom: 1px solid #334155;
            background: #0f172a;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: #64748b;
        }
        
        .cascade-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .cascade-item {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cascade-item:hover {
            background: #334155;
        }
        
        .cascade-item.selected {
            background: #1e40af;
            color: #fff;
            border-left: 3px solid #3b82f6;
            padding-left: 12px;
        }
        
        .cascade-item-badge {
            background: #334155;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .cascade-item.selected .cascade-item-badge {
            background: #3b82f6;
        }
        
        .cascade-empty {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #e2e8f0;
            font-family: inherit;
            font-size: 13px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            background: #0f172a;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #475569;
            color: #fff;
        }
        
        .btn-secondary:hover {
            background: #64748b;
        }
        
        .btn-danger {
            background: #dc2626;
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-success {
            background: #059669;
            color: #fff;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .message {
            padding: 12px 15px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
        }
        
        .message.success {
            background: #064e3b;
            color: #86efac;
            border: 1px solid #059669;
            display: block;
        }
        
        .message.error {
            background: #7f1d1d;
            color: #fca5a5;
            border: 1px solid #dc2626;
            display: block;
        }
        
        .table-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            background: #0f172a;
            border-bottom: 2px solid #334155;
        }
        
        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            font-size: 11px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
        }
        
        tbody tr:hover {
            background: #334155;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>TalCual</h1>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Diccionario</div>
                <div class="nav-item active" data-panel="dictionary">
                    üìö Gestor de Diccionario
                </div>
                <div class="nav-item" data-panel="words">
                    üî§ Palabras
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Partidas</div>
                <div class="nav-item" data-panel="games">
                    üéÆ Partidas Activas
                </div>
                <div class="nav-item" data-panel="games-finished">
                    ‚úì Partidas Finalizadas
                </div>
                <div class="nav-item" data-panel="players">
                    üë• Jugadores
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Herramientas</div>
                <div class="nav-item" data-panel="tools">
                    ‚öôÔ∏è Optimizaci√≥n
                </div>
                <div class="nav-item" data-panel="import-export">
                    üì§ Importar/Exportar
                </div>
                <div class="nav-item" data-panel="repair">
                    üîß Reparaci√≥n
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Inspector</div>
                <div class="nav-item" data-panel="inspect">
                    üîç Inspector de BD
                </div>
            </div>
        </div>
        
        <div class="main">
            <div class="header">
                <h2 id="pageTitle">Gestor de Diccionario</h2>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="catCount">0</div>
                        <div class="stat-label">Categor√≠as</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="promptCount">0</div>
                        <div class="stat-label">Consignas</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="wordCount">0</div>
                        <div class="stat-label">Palabras</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div id="message" class="message"></div>
                
                <!-- DICTIONARY PANEL -->
                <div id="dictionary" class="panel active">
                    <div class="cascading-view">
                        <!-- Categories Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">Categor√≠as</div>
                            <div class="cascade-list" id="categoriesList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%; text-align: center;" onclick="openAddCategoryModal()">+ Agregar Categor√≠a</button>
                            </div>
                        </div>
                        
                        <!-- Prompts Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">Consignas</div>
                            <div class="cascade-list" id="promptsList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%; text-align: center;" onclick="openAddPromptModal()">+ Agregar Consigna</button>
                            </div>
                        </div>
                        
                        <!-- Words Pane -->
                        <div class="cascade-pane">
                            <div class="cascade-header">Palabras</div>
                            <div class="cascade-list" id="wordsList"></div>
                            <div style="padding: 15px; border-top: 1px solid #334155;">
                                <button class="btn-primary" style="width: 100%; text-align: center;" onclick="openAddWordModal()">+ Agregar Palabra</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- WORDS PANEL (Full table view) -->
                <div id="words" class="panel">
                    <div class="message" id="wordsMessage"></div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Palabra</th>
                                    <th>Consigna</th>
                                    <th>G√©nero</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="wordsTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- GAMES PANEL -->
                <div id="games" class="panel">
                    <div class="message" id="gamesMessage"></div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Partida</th>
                                    <th>Estado</th>
                                    <th>Ronda</th>
                                    <th>Jugadores</th>
                                    <th>√öltima Actualizaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="gamesTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- GAMES FINISHED PANEL -->
                <div id="games-finished" class="panel">
                    <div class="message" id="gamesFinishedMessage"></div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID Partida</th>
                                    <th>Rondas</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="gamesFinishedTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- PLAYERS PANEL -->
                <div id="players" class="panel">
                    <div class="form-group">
                        <label>Filtrar por Partida:</label>
                        <input type="text" id="playerGameFilter" placeholder="ID de partida...">
                    </div>
                    <div class="message" id="playersMessage"></div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Jugador</th>
                                    <th>Partida</th>
                                    <th>Estado</th>
                                    <th>Puntuaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="playersTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- TOOLS PANEL -->
                <div id="tools" class="panel">
                    <h3 style="margin-bottom: 20px;">Herramientas de Optimizaci√≥n</h3>
                    
                    <div class="form-group">
                        <button class="btn-success" onclick="optimizeDatabase()" style="width: 100%;">üîß Optimizar Base de Datos</button>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn-secondary" onclick="cleanDisconnected()" style="width: 100%;">üßπ Limpiar Jugadores Desconectados</button>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn-secondary" onclick="archiveFinished()" style="width: 100%;">üì¶ Archivar Partidas Finalizadas</button>
                    </div>
                </div>
                
                <!-- IMPORT/EXPORT PANEL -->
                <div id="import-export" class="panel">
                    <h3 style="margin-bottom: 20px;">Importar/Exportar</h3>
                    
                    <div class="form-group">
                        <label>Importar desde JSON:</label>
                        <textarea id="importData" placeholder="Pega el JSON aqu√≠..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-primary" onclick="importData()" style="flex: 1;">üì• Importar</button>
                        <button class="btn-secondary" onclick="exportData()" style="flex: 1;">üì§ Exportar</button>
                    </div>
                </div>
                
                <!-- REPAIR PANEL -->
                <div id="repair" class="panel">
                    <h3 style="margin-bottom: 20px;">Reparaci√≥n y Diagn√≥stico</h3>
                    
                    <div class="form-group" id="diagnosticResults"></div>
                    
                    <div class="button-group">
                        <button class="btn-secondary" onclick="runDiagnostic()" style="flex: 1;">üîç Ejecutar Diagn√≥stico</button>
                        <button class="btn-danger" onclick="repairDatabase()" style="flex: 1;">‚ö†Ô∏è Reparar Base de Datos</button>
                    </div>
                </div>
                
                <!-- INSPECT PANEL -->
                <div id="inspect" class="panel">
                    <h3 style="margin-bottom: 20px;">Inspector de Base de Datos</h3>
                    <button class="btn-primary" onclick="inspectDatabase()" style="margin-bottom: 20px;">üîç Inspeccionar Base de Datos</button>
                    <div id="inspectResults"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API = 'dmanager.php';
        let selectedCategory = null;
        let selectedPrompt = null;
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            loadDictionary();
            updateStats();
            setInterval(updateStats, 5000);
        });
        
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    
                    item.classList.add('active');
                    const panelId = item.getAttribute('data-panel');
                    document.getElementById(panelId).classList.add('active');
                    
                    const titles = {
                        'dictionary': 'üìö Gestor de Diccionario',
                        'words': 'üî§ Palabras',
                        'games': 'üéÆ Partidas Activas',
                        'games-finished': '‚úì Partidas Finalizadas',
                        'players': 'üë• Jugadores',
                        'tools': '‚öôÔ∏è Herramientas',
                        'import-export': 'üì§ Importar/Exportar',
                        'repair': 'üîß Reparaci√≥n',
                        'inspect': 'üîç Inspector'
                    };
                    
                    document.getElementById('pageTitle').textContent = titles[panelId] || panelId;
                    
                    if (panelId === 'words') loadWordsTable();
                    if (panelId === 'games') loadGamesTable();
                    if (panelId === 'games-finished') loadFinishedGamesTable();
                    if (panelId === 'players') loadPlayersTable();
                });
            });
        }
        
        // ==================== DICTIONARY PANEL ====================
        async function loadDictionary() {
            try {
                const [categories, prompts, words] = await Promise.all([
                    fetch(`${API}?action=get-categories`).then(r => r.json()).then(r => r.data),
                    fetch(`${API}?action=get-prompts`).then(r => r.json()).then(r => r.data),
                    fetch(`${API}?action=get-words`).then(r => r.json()).then(r => r.data)
                ]);
                
                renderCategories(categories);
                if (selectedCategory) {
                    renderPrompts(prompts.filter(p => p.category_ids.includes(selectedCategory)));
                } else if (prompts.length > 0) {
                    renderPrompts(prompts);
                }
                
                if (selectedPrompt) {
                    renderWords(words.filter(w => w.prompt_id === selectedPrompt));
                }
            } catch (error) {
                showMessage('Error cargando diccionario: ' + error.message, 'error');
            }
        }
        
        function renderCategories(categories) {
            const list = document.getElementById('categoriesList');
            if (categories.length === 0) {
                list.innerHTML = '<div class="cascade-empty">No hay categor√≠as</div>';
                return;
            }
            
            list.innerHTML = categories
                .sort((a, b) => a.orden - b.orden)
                .map(cat => `
                    <div class="cascade-item ${selectedCategory === cat.id ? 'selected' : ''}" onclick="selectCategory(${cat.id})">
                        <span>${cat.name}</span>
                        <span class="cascade-item-badge">${cat.id}</span>
                    </div>
                `).join('');
        }
        
        function renderPrompts(prompts) {
            const list = document.getElementById('promptsList');
            if (prompts.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Selecciona una categor√≠a</div>';
                return;
            }
            
            list.innerHTML = prompts
                .sort((a, b) => a.text.localeCompare(b.text))
                .map(p => `
                    <div class="cascade-item ${selectedPrompt === p.id ? 'selected' : ''}" onclick="selectPrompt(${p.id})">
                        <span>${p.text}</span>
                        <span class="cascade-item-badge">${p.difficulty}</span>
                    </div>
                `).join('');
        }
        
        function renderWords(words) {
            const list = document.getElementById('wordsList');
            if (words.length === 0) {
                list.innerHTML = '<div class="cascade-empty">Selecciona una consigna</div>';
                return;
            }
            
            list.innerHTML = words
                .sort((a, b) => a.word_entry.localeCompare(b.word_entry))
                .map(w => `
                    <div class="cascade-item">
                        <span>${w.word_entry}</span>
                        <span class="cascade-item-badge">${w.gender || 'n'}</span>
                    </div>
                `).join('');
        }
        
        function selectCategory(catId) {
            selectedCategory = catId;
            selectedPrompt = null;
            loadDictionary();
        }
        
        async function selectPrompt(promptId) {
            selectedPrompt = promptId;
            const words = await fetch(`${API}?action=get-words&prompt_id=${promptId}`).then(r => r.json()).then(r => r.data);
            renderWords(words);
        }
        
        // ==================== WORDS TABLE ====================
        async function loadWordsTable() {
            try {
                const words = await fetch(`${API}?action=get-words`).then(r => r.json()).then(r => r.data);
                const html = words.map(w => `
                    <tr>
                        <td>${w.word_entry}</td>
                        <td>${w.prompt_id}</td>
                        <td>${w.gender || '-'}</td>
                        <td>
                            <button class="btn-secondary" onclick="editWord(${w.id})">Editar</button>
                            <button class="btn-danger" onclick="deleteWord(${w.id})">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('wordsTable').innerHTML = html || '<tr><td colspan="4" style="text-align: center; padding: 20px;">No hay palabras</td></tr>';
            } catch (error) {
                showMessage('Error cargando palabras: ' + error.message, 'error', 'wordsMessage');
            }
        }
        
        // ==================== GAMES TABLE ====================
        async function loadGamesTable() {
            try {
                const games = await fetch(`${API}?action=get-active-games`).then(r => r.json()).then(r => r.data);
                const html = games.map(g => `
                    <tr>
                        <td>${g.id}</td>
                        <td>${g.status}</td>
                        <td>${g.round}</td>
                        <td>${g.player_count}</td>
                        <td>${g.updated_at ? new Date(g.updated_at * 1000).toLocaleString() : '-'}</td>
                        <td>
                            <button class="btn-secondary" onclick="viewGame('${g.id}')">Ver</button>
                            <button class="btn-danger" onclick="deleteGame('${g.id}')">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('gamesTable').innerHTML = html || '<tr><td colspan="6" style="text-align: center; padding: 20px;">No hay partidas activas</td></tr>';
            } catch (error) {
                showMessage('Error cargando partidas: ' + error.message, 'error', 'gamesMessage');
            }
        }
        
        async function loadFinishedGamesTable() {
            try {
                const games = await fetch(`${API}?action=get-finished-games`).then(r => r.json()).then(r => r.data);
                const html = games.map(g => `
                    <tr>
                        <td>${g.id}</td>
                        <td>${g.round} / ${g.total_rounds}</td>
                        <td>${g.updated_at ? new Date(g.updated_at * 1000).toLocaleString() : '-'}</td>
                        <td>
                            <button class="btn-danger" onclick="deleteGame('${g.id}')">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('gamesFinishedTable').innerHTML = html || '<tr><td colspan="4" style="text-align: center; padding: 20px;">No hay partidas finalizadas</td></tr>';
            } catch (error) {
                showMessage('Error cargando partidas finalizadas: ' + error.message, 'error', 'gamesFinishedMessage');
            }
        }
        
        async function loadPlayersTable() {
            try {
                showMessage('Cargando jugadores...', 'success', 'playersMessage');
            } catch (error) {
                showMessage('Error cargando jugadores: ' + error.message, 'error', 'playersMessage');
            }
        }
        
        // ==================== ACTIONS ====================
        async function updateStats() {
            try {
                const res = await fetch(`${API}?action=inspect`).then(r => r.json());
                if (res.success && res.data && res.data.stats) {
                    const stats = res.data.stats;
                    document.getElementById('catCount').textContent = stats.categories;
                    document.getElementById('promptCount').textContent = stats.prompts;
                    document.getElementById('wordCount').textContent = stats.words;
                }
            } catch (error) {
                console.error('Error actualizando estad√≠sticas:', error);
            }
        }
        
        async function deleteGame(gameId) {
            if (!confirm('¬øEliminar esta partida?')) return;
            try {
                const res = await fetch(`${API}?action=delete-game`, {
                    method: 'POST',
                    body: JSON.stringify({ id: gameId }),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage('Partida eliminada', 'success', 'gamesMessage');
                    loadGamesTable();
                    loadFinishedGamesTable();
                } else {
                    showMessage('Error: ' + res.message, 'error', 'gamesMessage');
                }
            } catch (error) {
                showMessage('Error eliminando partida: ' + error.message, 'error', 'gamesMessage');
            }
        }
        
        async function deleteWord(wordId) {
            if (!confirm('¬øEliminar esta palabra?')) return;
            try {
                const res = await fetch(`${API}?action=delete-word`, {
                    method: 'POST',
                    body: JSON.stringify({ id: wordId }),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage('Palabra eliminada', 'success', 'wordsMessage');
                    loadWordsTable();
                } else {
                    showMessage('Error: ' + res.message, 'error', 'wordsMessage');
                }
            } catch (error) {
                showMessage('Error eliminando palabra: ' + error.message, 'error', 'wordsMessage');
            }
        }
        
        async function optimizeDatabase() {
            try {
                const res = await fetch(`${API}?action=optimize`, { method: 'POST' }).then(r => r.json());
                showMessage(res.success ? '‚úì Base de datos optimizada' : 'Error: ' + res.message, res.success ? 'success' : 'error');
            } catch (error) {
                showMessage('Error optimizando: ' + error.message, 'error');
            }
        }
        
        async function cleanDisconnected() {
            try {
                const res = await fetch(`${API}?action=clean-disconnected`, { method: 'POST' }).then(r => r.json());
                showMessage(res.success ? `‚úì ${res.data.removed} jugadores removidos` : 'Error', res.success ? 'success' : 'error');
            } catch (error) {
                showMessage('Error limpiando: ' + error.message, 'error');
            }
        }
        
        async function archiveFinished() {
            try {
                const res = await fetch(`${API}?action=archive-finished`, { method: 'POST' }).then(r => r.json());
                showMessage(res.success ? `‚úì ${res.data.archived} partidas archivadas` : 'Error', res.success ? 'success' : 'error');
            } catch (error) {
                showMessage('Error archivando: ' + error.message, 'error');
            }
        }
        
        async function repairDatabase() {
            if (!confirm('¬øReparar y reinicializar base de datos? Esto eliminar√° todos los datos.')) return;
            try {
                const res = await fetch(`${API}?action=repair`, { method: 'POST' }).then(r => r.json());
                showMessage(res.success ? '‚úì Base de datos reparada' : 'Error', res.success ? 'success' : 'error');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showMessage('Error reparando: ' + error.message, 'error');
            }
        }
        
        async function importData() {
            const data = document.getElementById('importData').value;
            if (!data) {
                showMessage('Pega datos JSON primero', 'error');
                return;
            }
            try {
                const json = JSON.parse(data);
                const res = await fetch(`${API}?action=import`, {
                    method: 'POST',
                    body: JSON.stringify(json),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage(`‚úì Importado: ${res.data.categories_added} categor√≠as, ${res.data.prompts_added} consignas, ${res.data.words_added} palabras`, 'success');
                    document.getElementById('importData').value = '';
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error importando: ' + error.message, 'error');
            }
        }
        
        async function exportData() {
            try {
                const res = await fetch(`${API}?action=export`).then(r => r.json());
                if (res.success) {
                    const json = JSON.stringify(res.data, null, 2);
                    document.getElementById('importData').value = json;
                    showMessage('‚úì Datos exportados', 'success');
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error exportando: ' + error.message, 'error');
            }
        }
        
        async function inspectDatabase() {
            try {
                const res = await fetch(`${API}?action=inspect`).then(r => r.json());
                if (res.success) {
                    const html = `<pre style="background: #1e293b; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 11px;">${JSON.stringify(res.data, null, 2)}</pre>`;
                    document.getElementById('inspectResults').innerHTML = html;
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error inspeccionando: ' + error.message, 'error');
            }
        }
        
        function openAddCategoryModal() {
            const name = prompt('Nombre de la categor√≠a:');
            if (name) addCategory(name);
        }
        
        function openAddPromptModal() {
            if (!selectedCategory) {
                showMessage('Selecciona una categor√≠a primero', 'error');
                return;
            }
            const text = prompt('Texto de la consigna:');
            if (text) addPrompt(text);
        }
        
        function openAddWordModal() {
            if (!selectedPrompt) {
                showMessage('Selecciona una consigna primero', 'error');
                return;
            }
            const word = prompt('Palabra:');
            if (word) addWord(word);
        }
        
        async function addCategory(name) {
            try {
                const res = await fetch(`${API}?action=add-category`, {
                    method: 'POST',
                    body: JSON.stringify({ name }),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage('‚úì Categor√≠a agregada', 'success');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function addPrompt(text) {
            try {
                const res = await fetch(`${API}?action=add-prompt`, {
                    method: 'POST',
                    body: JSON.stringify({
                        text,
                        category_ids: [selectedCategory]
                    }),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage('‚úì Consigna agregada', 'success');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        async function addWord(word) {
            try {
                const res = await fetch(`${API}?action=add-word`, {
                    method: 'POST',
                    body: JSON.stringify({
                        prompt_id: selectedPrompt,
                        word
                    }),
                    headers: { 'Content-Type': 'application/json' }
                }).then(r => r.json());
                
                if (res.success) {
                    showMessage('‚úì Palabra agregada', 'success');
                    loadDictionary();
                    updateStats();
                } else {
                    showMessage('Error: ' + res.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        function showMessage(msg, type = 'success', elementId = 'message') {
            const el = document.getElementById(elementId);
            el.textContent = msg;
            el.className = 'message ' + type;
            setTimeout(() => el.className = 'message', 5000);
        }
    </script>
</body>
</html>