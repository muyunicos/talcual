<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalCual - DB Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 12px; opacity: 0.9; }
        .container { max-width: 1400px; margin: 20px auto; display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 0 20px; }
        .main { display: flex; flex-direction: column; gap: 20px; }
        .panel { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .panel-body { padding: 20px; }
        .tabs { display: flex; border-bottom: 1px solid #e0e0e0; }
        .tab { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; flex: 1; text-align: center; font-size: 13px; }
        .tab.active { border-bottom-color: #667eea; background: white; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tree { list-style: none; padding: 0; }
        .tree-item { border-bottom: 1px solid #f0f0f0; }
        .tree-item:last-child { border-bottom: none; }
        .tree-category { padding: 15px; display: flex; align-items: center; gap: 10px; background: #fafafa; cursor: pointer; }
        .tree-category:hover { background: #f0f0f0; }
        .tree-category .toggle { width: 20px; text-align: center; }
        .tree-category .name { flex: 1; font-weight: 600; }
        .tree-category .count { font-size: 12px; color: #999; }
        .tree-category .actions { display: flex; gap: 5px; }
        .tree-clues { display: none; background: white; border-left: 3px solid #667eea; }
        .tree-clues.visible { display: block; }
        .tree-clue { padding: 12px 15px 12px 30px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .tree-clue:hover { background: #f9f9f9; }
        .tree-clue .pregunta { flex: 1; }
        .tree-clue .respuesta-count { font-size: 11px; color: #999; }
        .tree-clue-add { padding: 10px 15px 10px 30px; font-size: 12px; color: #667eea; cursor: pointer; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-icon { padding: 6px; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; background: #f0f0f0; border-radius: 4px; }
        .btn-icon:hover { background: #e0e0e0; }
        .btn-icon.delete:hover { background: #ffebee; color: #c62828; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .sidebar-panel { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .sidebar-panel h3 { background: #f8f9fa; padding: 12px 15px; font-size: 13px; border-bottom: 1px solid #e0e0e0; }
        .sidebar-panel-body { padding: 15px; font-size: 12px; }
        .stat { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .stat:last-child { border-bottom: none; }
        .stat-label { font-weight: 600; }
        .stat-value { color: #667eea; font-weight: 700; }
        .message { padding: 12px 15px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; display: none; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 16px; }
        .modal-close { background: none; border: none; font-size: 20px; cursor: pointer; padding: 0; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; justify-content: flex-end; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .form-group textarea { resize: vertical; min-height: 100px; font-family: monospace; }
        .clue-select { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; }
        .clue-select-item { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .clue-select-item:hover { background: #f9f9f9; }
        .search-box { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-bottom: 15px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .optimize-report { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; }
        .optimize-report h4 { margin-bottom: 10px; color: #333; }
        .optimize-report p { margin: 5px 0; }
        .optimize-report .issue { color: #c62828; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ TalCual - Database Admin Panel</h1>
        <p>Gestiona categor√≠as, consignas y respuestas</p>
    </div>
    
    <div class="container">
        <div class="main">
            <div class="message" id="message"></div>
            
            <div class="panel">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('explorer')">Explorer</div>
                    <div class="tab" onclick="switchTab('import')">Importar</div>
                    <div class="tab" onclick="switchTab('raw')">JSON Raw</div>
                </div>
                
                <div id="explorer" class="tab-content active">
                    <div class="panel-body">
                        <div style="margin-bottom: 15px;">
                            <button class="btn-primary" onclick="showNewCategoryModal()">+ Nueva Categor√≠a</button>
                        </div>
                        <ul class="tree" id="tree"></ul>
                        <div id="emptyState" class="empty-state">
                            <div style="font-size: 40px; margin-bottom: 10px;">üìö</div>
                            <p>No hay datos. Importa un JSON o crea una nueva categor√≠a.</p>
                        </div>
                    </div>
                </div>
                
                <div id="import" class="tab-content">
                    <div class="panel-body">
                        <div class="form-group">
                            <label>Importar archivo JSON</label>
                            <input type="file" id="fileInput" accept=".json">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="importJSON()">Importar</button>
                            <button class="btn-secondary" onclick="exportJSON()">Exportar</button>
                        </div>
                    </div>
                </div>
                
                <div id="raw" class="tab-content">
                    <div class="panel-body">
                        <div class="toolbar">
                            <button class="btn-primary" onclick="optimizeJSON()">üîß Optimizar</button>
                            <button class="btn-secondary" onclick="loadRawJSON()">Recargar</button>
                        </div>
                        <div id="optimizeReport" class="optimize-report" style="display: none;"></div>
                        <textarea id="rawJSON" style="width: 100%; height: 350px; font-family: monospace; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; padding: 10px;"></textarea>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="saveRawJSON()">Guardar cambios</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="sidebar-panel">
                <h3>üìä Estad√≠sticas</h3>
                <div class="sidebar-panel-body">
                    <div class="stat">
                        <span class="stat-label">Categor√≠as:</span>
                        <span class="stat-value" id="statCats">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Consignas:</span>
                        <span class="stat-value" id="statClues">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Respuestas:</span>
                        <span class="stat-value" id="statResps">0</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-panel">
                <h3>‚öúÔ∏è Ayuda</h3>
                <div class="sidebar-panel-body">
                    <p><strong>+:</strong> Agregar consigna</p>
                    <p><strong>üåü:</strong> Nueva consigna r√°pido</p>
                    <p><strong>‚úé:</strong> Editar</p>
                    <p><strong>‚Üë‚Üì:</strong> Mover</p>
                    <p><strong>üóë:</strong> Quitar/Eliminar</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modales -->
    <div class="modal" id="newCategoryModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Nueva Categor√≠a</h2><button class="modal-close" onclick="closeModal('newCategoryModal')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="newCatName" placeholder="Ej: AMOR Y CITAS ‚ù§Ô∏è">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('newCategoryModal')">Cancelar</button>
                <button class="btn-primary" onclick="createCategory()">Crear</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="newClueModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Nueva Consigna</h2><button class="modal-close" onclick="closeModal('newClueModal')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Pregunta</label>
                    <textarea id="newCluePregunta"></textarea>
                </div>
                <div class="form-group">
                    <label>Respuestas (una por l√≠nea, usa | para sin√≥nimos)</label>
                    <textarea id="newClueRespuestas"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('newClueModal')">Cancelar</button>
                <button class="btn-primary" onclick="createClue()">Crear</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="editClueModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Editar Consigna</h2><button class="modal-close" onclick="closeModal('editClueModal')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Pregunta</label>
                    <textarea id="editCluePregunta"></textarea>
                </div>
                <div class="form-group">
                    <label>Respuestas (una por l√≠nea)</label>
                    <textarea id="editClueRespuestas"></textarea>
                </div>
                <button class="btn-secondary" onclick="deleteClueCompletely()" style="background: #ffebee; color: #c62828;">Eliminar completamente</button>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('editClueModal')">Cancelar</button>
                <button class="btn-primary" onclick="saveEditClue()">Guardar</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="editCategoryModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Editar Categor√≠a</h2><button class="modal-close" onclick="closeModal('editCategoryModal')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="editCatName">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('editCategoryModal')">Cancelar</button>
                <button class="btn-primary" onclick="saveEditCategory()">Guardar</button>
                <button class="btn-secondary" onclick="deleteCategory()" style="background: #ffebee; color: #c62828;">Eliminar</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="addExistingClueModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Agregar Consigna Existente</h2><button class="modal-close" onclick="closeModal('addExistingClueModal')">√ó</button></div>
            <div class="modal-body">
                <input type="text" id="clueSearchBox" placeholder="Buscar consigna..." class="search-box" oninput="filterClueList()">
                <div class="clue-select" id="clueSelectList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('addExistingClueModal')">Cancelar</button>
                <button class="btn-primary" onclick="addSelectedClues()">Agregar</button>
            </div>
        </div>
    </div>

    <script>
        let db = { categorias: {}, consignas: {} };
        let currentEditingClue = null;
        let currentEditingCategory = null;
        let currentCategoryForAdd = null;
        
        function fixDB() {
            if (!db.categorias) db.categorias = {};
            if (!db.consignas) db.consignas = {};
            if (Array.isArray(db.categorias)) db.categorias = {};
            if (Array.isArray(db.consignas)) db.consignas = {};
        }
        
        async function loadDB() {
            try {
                const res = await fetch('dmanager.php?action=get-db');
                const result = await res.json();
                if (result.success && result.data) {
                    db = result.data;
                    fixDB();
                    renderTree();
                    updateStats();
                } else {
                    db = { categorias: {}, consignas: {} };
                }
            } catch (err) {
                showMessage('‚ùå Error al cargar: ' + err.message, 'error');
            }
        }
        
        function renderTree() {
            const tree = document.getElementById('tree');
            const categories = Object.entries(db.categorias).sort((a, b) => a[1].orden - b[1].orden);
            
            if (categories.length === 0) {
                tree.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            
            tree.innerHTML = categories.map(([catName, catData]) => `
                <li class="tree-item">
                    <div class="tree-category" onclick="toggleCategory(this)">
                        <span class="toggle">‚ñ∂</span>
                        <span class="name">${catName}</span>
                        <span class="count">${catData.consignas.length}</span>
                        <div class="actions">
                            <span class="btn-icon" onclick="event.stopPropagation(); showAddExistingClueModal('${catName}')" title="+ Existente">+</span>
                            <span class="btn-icon" onclick="event.stopPropagation(); showNewClueModal('${catName}')" title="+ Nueva">üåü</span>
                            <span class="btn-icon" onclick="event.stopPropagation(); showEditCategoryModal('${catName}')" title="Editar">‚úé</span>
                            <span class="btn-icon delete" onclick="event.stopPropagation(); deleteCategory('${catName}')" title="Eliminar">üóë</span>
                        </div>
                    </div>
                    <ul class="tree-clues">
                        ${catData.consignas.map((clueId) => {
                            const clue = db.consignas[clueId];
                            if (!clue) return `<li style="padding: 10px 30px; color: #c62828; font-size: 11px;">‚ö† Consigna ${clueId} inexistente</li>`;
                            const preg = clue.pregunta.substring(0, 35);
                            return `
                                <li class="tree-clue">
                                    <span class="pregunta" title="${clue.pregunta}">${preg}${clue.pregunta.length > 35 ? '...' : ''}</span>
                                    <span class="respuesta-count">${clue.respuestas.length}</span>
                                    <div class="actions">
                                        <span class="btn-icon" onclick="event.stopPropagation(); moveClue('${catName}', '${clueId}', -1)">‚Üë</span>
                                        <span class="btn-icon" onclick="event.stopPropagation(); moveClue('${catName}', '${clueId}', 1)">‚Üì</span>
                                        <span class="btn-icon" onclick="event.stopPropagation(); editClue('${clueId}')">‚úé</span>
                                        <span class="btn-icon delete" onclick="event.stopPropagation(); removeClueFromCategory('${catName}', '${clueId}')">üóë</span>
                                    </div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </li>
            `).join('');
        }
        
        function toggleCategory(el) {
            const isExp = el.classList.contains('expanded');
            el.classList.toggle('expanded');
            el.querySelector('.toggle').textContent = isExp ? '‚ñ∂' : '‚ñº';
            el.nextElementSibling.classList.toggle('visible');
        }
        
        function moveClue(catName, clueId, dir) {
            const clues = db.categorias[catName].consignas;
            const idx = clues.indexOf(clueId);
            const newIdx = idx + dir;
            if (newIdx >= 0 && newIdx < clues.length) {
                [clues[idx], clues[newIdx]] = [clues[newIdx], clues[idx]];
                saveDB().then(() => renderTree());
            }
        }
        
        async function showNewClueModal(catName = null) {
            currentEditingCategory = catName;
            document.getElementById('newCluePregunta').value = '';
            document.getElementById('newClueRespuestas').value = '';
            document.getElementById('newClueModal').classList.add('show');
        }
        
        function showNewCategoryModal() {
            document.getElementById('newCatName').value = '';
            document.getElementById('newCategoryModal').classList.add('show');
        }
        
        async function createCategory() {
            const name = document.getElementById('newCatName').value.trim();
            if (!name) { showMessage('‚ùå Nombre requerido', 'error'); return; }
            if (db.categorias[name]) { showMessage('‚ùå La categor√≠a ya existe', 'error'); return; }
            
            const orden = Math.max(...Object.values(db.categorias).map(c => c.orden || 0), 0) + 1;
            db.categorias[name] = { orden, consignas: [] };
            await saveDB();
            closeModal('newCategoryModal');
            renderTree();
            updateStats();
        }
        
        async function createClue() {
            const pregunta = document.getElementById('newCluePregunta').value.trim();
            const respuestasText = document.getElementById('newClueRespuestas').value.trim();
            
            if (!pregunta || !respuestasText) { showMessage('‚ùå Pregunta y respuestas requeridas', 'error'); return; }
            
            const respuestas = respuestasText.split('\n').map(r => r.trim()).filter(r => r);
            const clueId = 'clue_' + Date.now();
            
            db.consignas[clueId] = {
                pregunta,
                respuestas,
                created_at: new Date().toISOString()
            };
            
            if (currentEditingCategory && db.categorias[currentEditingCategory]) {
                db.categorias[currentEditingCategory].consignas.push(clueId);
            }
            
            await saveDB();
            closeModal('newClueModal');
            renderTree();
            updateStats();
        }
        
        function editClue(clueId) {
            currentEditingClue = clueId;
            const clue = db.consignas[clueId];
            if (clue) {
                document.getElementById('editCluePregunta').value = clue.pregunta;
                document.getElementById('editClueRespuestas').value = clue.respuestas.join('\n');
                document.getElementById('editClueModal').classList.add('show');
            }
        }
        
        async function saveEditClue() {
            if (!currentEditingClue) return;
            
            const pregunta = document.getElementById('editCluePregunta').value.trim();
            const respuestasText = document.getElementById('editClueRespuestas').value.trim();
            
            if (!pregunta || !respuestasText) { showMessage('‚ùå Campos requeridos', 'error'); return; }
            
            const respuestas = respuestasText.split('\n').map(r => r.trim()).filter(r => r);
            db.consignas[currentEditingClue].pregunta = pregunta;
            db.consignas[currentEditingClue].respuestas = respuestas;
            
            await saveDB();
            closeModal('editClueModal');
            renderTree();
            updateStats();
        }
        
        function deleteClueCompletely() {
            if (!currentEditingClue || !confirm('¬øEliminar consigna de TODAS las categor√≠as?')) return;
            
            for (const cat of Object.values(db.categorias)) {
                cat.consignas = cat.consignas.filter(id => id !== currentEditingClue);
            }
            delete db.consignas[currentEditingClue];
            
            saveDB().then(() => {
                closeModal('editClueModal');
                renderTree();
                updateStats();
            });
        }
        
        function removeClueFromCategory(catName, clueId) {
            if (!db.categorias[catName]) return;
            db.categorias[catName].consignas = db.categorias[catName].consignas.filter(id => id !== clueId);
            saveDB().then(() => renderTree());
        }
        
        function showEditCategoryModal(catName) {
            currentEditingCategory = catName;
            document.getElementById('editCatName').value = catName;
            document.getElementById('editCategoryModal').classList.add('show');
        }
        
        async function saveEditCategory() {
            if (!currentEditingCategory) return;
            const newName = document.getElementById('editCatName').value.trim();
            if (!newName) { showMessage('‚ùå Nombre requerido', 'error'); return; }
            if (newName !== currentEditingCategory && db.categorias[newName]) { showMessage('‚ùå Ya existe', 'error'); return; }
            
            if (newName !== currentEditingCategory) {
                db.categorias[newName] = db.categorias[currentEditingCategory];
                delete db.categorias[currentEditingCategory];
            }
            
            await saveDB();
            closeModal('editCategoryModal');
            renderTree();
            updateStats();
        }
        
        function deleteCategory(catName = currentEditingCategory) {
            if (!catName || !confirm(`¬øEliminar "${catName}"?`)) return;
            delete db.categorias[catName];
            saveDB().then(() => {
                closeModal('editCategoryModal');
                renderTree();
                updateStats();
            });
        }
        
        function showAddExistingClueModal(catName) {
            currentCategoryForAdd = catName;
            populateClueSelectList();
            document.getElementById('addExistingClueModal').classList.add('show');
        }
        
        function populateClueSelectList() {
            const list = document.getElementById('clueSelectList');
            const existingClues = new Set(db.categorias[currentCategoryForAdd]?.consignas || []);
            
            if (Object.keys(db.consignas).length === 0) {
                list.innerHTML = '<div style="padding: 10px; color: #999;">No hay consignas disponibles</div>';
                return;
            }
            
            list.innerHTML = Object.entries(db.consignas).map(([clueId, clue]) => `
                <div class="clue-select-item">
                    <input type="checkbox" id="clue_${clueId}" value="${clueId}" ${existingClues.has(clueId) ? 'checked disabled' : ''}>
                    <label for="clue_${clueId}" style="flex: 1;">${clue.pregunta.substring(0, 50)}</label>
                </div>
            `).join('');
        }
        
        function filterClueList() {
            const searchTerm = document.getElementById('clueSearchBox').value.toLowerCase();
            document.querySelectorAll('.clue-select-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        async function addSelectedClues() {
            const checked = document.querySelectorAll('#clueSelectList input:checked:not(:disabled)');
            const clueIds = Array.from(checked).map(cb => cb.value);
            
            if (clueIds.length === 0) { showMessage('‚ùå Selecciona consignas', 'error'); return; }
            
            clueIds.forEach(clueId => {
                if (!db.categorias[currentCategoryForAdd].consignas.includes(clueId)) {
                    db.categorias[currentCategoryForAdd].consignas.push(clueId);
                }
            });
            
            await saveDB();
            closeModal('addExistingClueModal');
            renderTree();
            updateStats();
        }
        
        async function importJSON() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) { showMessage('‚ùå Selecciona archivo', 'error'); return; }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    const res = await fetch('dmanager.php?action=import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(imported)
                    });
                    
                    const result = await res.json();
                    if (result.success) {
                        db = result.data;
                        fixDB();
                        renderTree();
                        updateStats();
                        loadRawJSON();
                        showMessage('‚úÖ Importado', 'success');
                    } else {
                        showMessage('‚ùå ' + result.message, 'error');
                    }
                } catch (err) {
                    showMessage('‚ùå ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `talcual-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function loadRawJSON() {
            document.getElementById('rawJSON').value = JSON.stringify(db, null, 2);
            document.getElementById('optimizeReport').style.display = 'none';
        }
        
        async function optimizeJSON() {
            const res = await fetch('dmanager.php?action=optimize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(db)
            });
            
            const result = await res.json();
            if (result.success) {
                db = result.data.data;
                fixDB();
                loadRawJSON();
                renderTree();
                updateStats();
                
                const report = result.data.report;
                const reportHTML = `
                    <h4>üöß Reporte de Optimizaci√≥n</h4>
                    <p><strong>Antes:</strong> ${report.before.categorias} cat, ${report.before.consignas} consignas, ${report.before.respuestas} respuestas</p>
                    <p><strong>Despu√©s:</strong> ${report.after.categorias} cat, ${report.after.consignas} consignas, ${report.after.respuestas} respuestas</p>
                    ${report.issues.length > 0 ? '<p class="issue"><strong>üëÜ Problemas corregidos:</strong></p>' + report.issues.map(i => `<p class="issue">‚Ä¢ ${i}</p>`).join('') : '<p>‚úÖ Sin problemas detectados</p>'}
                `;
                
                const reportEl = document.getElementById('optimizeReport');
                reportEl.innerHTML = reportHTML;
                reportEl.style.display = 'block';
                
                showMessage('‚úÖ Base de datos optimizada', 'success');
            } else {
                showMessage('‚ùå ' + result.message, 'error');
            }
        }
        
        async function saveRawJSON() {
            try {
                db = JSON.parse(document.getElementById('rawJSON').value);
                fixDB();
                await saveDB();
                renderTree();
                updateStats();
                showMessage('‚úÖ Guardado', 'success');
            } catch (err) {
                showMessage('‚ùå JSON inv√°lido: ' + err.message, 'error');
            }
        }
        
        async function saveDB() {
            fixDB();
            const res = await fetch('dmanager.php?action=save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(db)
            });
            const result = await res.json();
            if (!result.success) showMessage('‚ùå Error al guardar', 'error');
        }
        
        function updateStats() {
            const cats = Object.keys(db.categorias).length;
            const clues = Object.keys(db.consignas).length;
            const resps = Object.values(db.consignas).reduce((sum, c) => sum + (c.respuestas || []).length, 0);
            
            document.getElementById('statCats').textContent = cats;
            document.getElementById('statClues').textContent = clues;
            document.getElementById('statResps').textContent = resps;
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'raw') loadRawJSON();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        function showMessage(msg, type) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = `message show ${type}`;
            if (type === 'success') setTimeout(() => el.classList.remove('show'), 3000);
        }
        
        loadDB();
    </script>
</body>
</html>
