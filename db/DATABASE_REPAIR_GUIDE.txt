â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         TalCual Database Repair & Recovery Guide                    â•‘
â•‘         Admin Tools for SQLite Database Management                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMA DETECTADO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
El archivo /data/talcual.db estÃ¡ corrupto o no existe.
Mensaje de error: "file is not a database"

CAUSAS POSIBLES:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. El archivo nunca fue creado (primera ejecuciÃ³n)
2. El archivo fue truncado o sobrescrito
3. El contenido no es un archivo SQLite vÃ¡lido
4. Conflicto con JSON vs SQLite (cambio de tecnologÃ­a)


SOLUCIÃ“N RÃPIDA (Paso a Paso):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Accede al Admin Panel de ReparaciÃ³n:
   URL: http://juegos.loc.ar/talcual/db/repair.html

2. Ejecuta en orden (cada botÃ³n tiene un propÃ³sito):

   A) "Check Status" ğŸ”
      â†’ Diagnostica el estado actual de la BD
      â†’ Verifica integridad y validez del archivo
      â†’ Si dice "file is not a database" â†’ continÃºa con B

   B) "Backup" ğŸ’¾ (OPCIONAL pero recomendado)
      â†’ Respalda el archivo corrupto
      â†’ Se guarda en /data/backups/talcual_TIMESTAMP.db.bak
      â†’ Ãštil para anÃ¡lisis forense posterior

   C) "Nuke & Reinitialize" ğŸ”¥ (ACCIÃ“N CRÃTICA)
      â†’ Elimina el archivo corrupto
      â†’ Crea una nueva BD SQLite limpia y funcional
      â†’ Recrea todas las tablas requeridas:
         - games (partidas)
         - players (jugadores)
         - categories (categorÃ­as del diccionario)
         - prompts (preguntas/consignas)
         - prompt_categories (relaciÃ³n M2M)
         - valid_words (palabras vÃ¡lidas)
      â†’ Requiere confirmaciÃ³n (âš ï¸ irreversible)
      â†’ âœ“ RECOMENDADO si el archivo estÃ¡ corrupto


OPCIONES ALTERNATIVAS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢ "Repair (Auto-Fix)" ğŸ”§
  â†’ Intenta reparar automÃ¡ticamente
  â†’ Ejecuta PRAGMA integrity_check
  â†’ Ejecuta VACUUM para optimizar
  â†’ Si falla â†’ cae en cascada a "Nuke & Reinitialize"
  â†’ Menos invasivo que Nuke (conserva datos si es posible)

â€¢ "Initialize Fresh DB" âš™ï¸
  â†’ Solo crea tablas e Ã­ndices
  â†’ NO borra el archivo existente
  â†’ Ãštil si la BD existe pero estÃ¡ vacÃ­a


QUÃ‰ SUCEDE DESPUÃ‰S DEL REPAIR:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Una vez que ejecutes "Nuke & Reinitialize" exitosamente:

1. âœ“ Se crea /data/talcual.db (nuevo archivo SQLite limpio)
2. âœ“ Se crea copia de seguridad en /data/backups/
3. âœ“ Se crean 6 tablas con esquema correcto
4. âœ“ Se crean 4 Ã­ndices para optimizaciÃ³n
5. âœ“ El juego puede ser usado nuevamente
6. âœ“ Se puede importar diccionario viejo si es necesario


RECUPERACIÃ“N DE DATOS (si tenÃ­as un diccionario viejo):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Si tienes un archivo JSON con diccionario anterior:

1. Ve a: http://juegos.loc.ar/talcual/db/
2. Usa la secciÃ³n "Import Dictionary" en AdminDictionary
3. Carga el JSON del diccionario anterior
4. Los datos se importarÃ¡n inteligentemente a las nuevas tablas

NOTA: El archivo /app/dictionary.json es crÃ­tico y se usa
mientras no haya datos en la BD SQLite.


ESTRUCTURA DE TABLAS CREADAS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GAMES
â”€â”€â”€â”€â”€
Almacena estado de cada partida en vivo.
Campos clave:
  - id: CÃ³digo de sala (ej: "ABCD")
  - status: waiting | playing | finished
  - round: NÃºmero de ronda actual
  - current_prompt: Texto de pregunta actual (snapshot)
  - current_category: CategorÃ­a activa
  - Tiempos: round_started_at, round_starts_at, round_ends_at
  - ConfiguraciÃ³n inmutable: total_rounds, round_duration, etc.

PLAYERS
â”€â”€â”€â”€â”€â”€â”€
Almacena identidad y estado de cada jugador.
Campos clave:
  - id: ID Ãºnico del jugador
  - game_id: Referencia a la partida
  - name: Nombre mostrado
  - score: Puntaje acumulado (cache)
  - current_answers: JSON array de respuestas actuales
  - round_history: JSON object con historial por ronda

CATEGORIES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CategorÃ­as del diccionario (ej: "Cosas de Cocina")
Tabla simple: id, name (UNIQUE)

PROMPTS
â”€â”€â”€â”€â”€â”€â”€
Preguntas/Consignas del juego (ej: "Utensilios de madera")
Tabla simple: id, text (UNIQUE)

PROMPT_CATEGORIES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RelaciÃ³n Many-to-Many entre prompts y categorÃ­as.
Permite que una pregunta pertenezca a mÃºltiples categorÃ­as.
Tabla de asociaciÃ³n: (prompt_id, category_id)

VALID_WORDS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Palabras vÃ¡lidas para cada pregunta.
Campos: id, prompt_id, word_entry (forma canÃ³nica)
Indexado por prompt_id para bÃºsquedas rÃ¡pidas.


ÃNDICES CREADOS (OptimizaciÃ³n):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â€¢ idx_players_game_id
  â†’ Acelera bÃºsquedas de jugadores por partida

â€¢ idx_prompt_categories_prompt
  â†’ Acelera bÃºsquedas de categorÃ­as para una pregunta

â€¢ idx_prompt_categories_category
  â†’ Acelera bÃºsquedas de preguntas para una categorÃ­a

â€¢ idx_valid_words_prompt_id
  â†’ Acelera bÃºsquedas de palabras vÃ¡lidas


PRAGMAS SQLite CONFIGURADAS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Al crear la BD, se aplican automÃ¡ticamente:

â€¢ PRAGMA journal_mode = WAL
  â†’ Write-Ahead Logging: mejor rendimiento, menos bloqueos

â€¢ PRAGMA foreign_keys = ON
  â†’ Enforza integridad referencial (fk constraints)

â€¢ PRAGMA synchronous = NORMAL
  â†’ Balance entre velocidad y seguridad

â€¢ PRAGMA wal_autocheckpoint = 1000
  â†’ Checkpoint automÃ¡tico cada 1000 cambios


ARCHIVOS DE RESPALDO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Todos los backups se guardan en: /data/backups/
Nombre: talcual_YYYY-MM-DD_HH-ii-ss.db.bak

Puedes conservarlos indefinidamente o eliminar despuÃ©s de verificar
que la nueva BD funciona correctamente.


SOLUCIÃ“N DE PROBLEMAS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Si "Check Status" aÃºn muestra errores despuÃ©s de Nuke & Reinitialize:

1. Verifica permisos del directorio /data/
   Debe ser 755 y ownership correcto (www-data en Apache)

2. Verifica que /data/ exista y sea escribible
   $ sudo chmod 755 /var/www/html/talcual/data

3. Si el error persiste, contacta al desarrollador con:
   - Output completo de "Check Status"
   - Contenido de PHP error logs
   - Permisos de archivos (ls -la /data/)


COMANDOS DE LÃNEA DE COMANDOS (Alternativa):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Si prefieres CLI en lugar del UI:

# Revisar estado
curl "http://juegos.loc.ar/talcual/db/repair-database.php?action=status"

# Crear backup
curl "http://juegos.loc.ar/talcual/db/repair-database.php?action=backup"

# Nuke & Reinitialize
curl -X POST "http://juegos.loc.ar/talcual/db/repair-database.php?action=nuke"


REFERENCI AS ÃšTILES:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â€¢ AdminDictionary.php â†’ GestiÃ³n avanzada del diccionario
â€¢ dmanager.php â†’ Gestor de operaciones de BD
â€¢ Database.php â†’ Clase singleton de conexiÃ³n
â€¢ repair-database.php â†’ Script de reparaciÃ³n (ESTE ARCHIVO)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ãšltima actualizaciÃ³n: 2026-01-06
Autor: TalCual Development Team
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
