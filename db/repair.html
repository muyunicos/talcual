<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalCual - Database Repair Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-box {
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 25px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            color: #333;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-box.loading {
            border-left-color: #ffa500;
        }

        .status-box.success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .status-box.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .status-box.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .button-group.full {
            grid-template-columns: 1fr;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(244, 67, 54, 0.4);
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #f57c00;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.4);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #388e3c;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(76, 175, 80, 0.4);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
            color: #1565c0;
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: -2px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .response {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .timestamp {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß TalCual Database Repair</h1>
        <p class="subtitle">SQLite Database Management & Recovery Tools</p>

        <div class="info-box">
            <strong>Descripci√≥n:</strong>
            Herramientas para diagnosticar, reparar y reinicializar la base de datos SQLite de TalCual. Ejecuta estas acciones en el siguiente orden:
            <br><br>
            1Ô∏è‚É£ <strong>Check Status</strong> - Diagnostica el estado actual
            <br>
            2Ô∏è‚É£ <strong>Backup</strong> - Respalda la BD corrupta (opcional)
            <br>
            3Ô∏è‚É£ <strong>Nuke & Reinitialize</strong> - Borra y crea una nueva limpia
        </div>

        <div class="status-box" id="status">
            Click "Check Status" para comenzar...
        </div>

        <div class="button-group">
            <button class="btn-primary" onclick="checkStatus()">üìä Check Status</button>
            <button class="btn-warning" onclick="backup()">üíæ Backup</button>
        </div>

        <div class="button-group">
            <button class="btn-danger" onclick="nuke()" style="grid-column: 1;">üî• Nuke & Reinitialize</button>
            <button class="btn-success" onclick="repair()">üîß Repair (Auto-Fix)</button>
        </div>

        <div class="button-group full">
            <button class="btn-primary" onclick="initialize()">‚öôÔ∏è Initialize Fresh DB</button>
        </div>

        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const timestampEl = document.getElementById('timestamp');

        function updateStatus(message, type = 'loading') {
            statusEl.textContent = message;
            statusEl.className = 'status-box ' + type;
            timestampEl.textContent = new Date().toLocaleTimeString();
        }

        function appendStatus(message) {
            statusEl.textContent += '\n' + message;
            statusEl.scrollTop = statusEl.scrollHeight;
        }

        async function call(action) {
            const params = new URLSearchParams({ action });
            try {
                const response = await fetch(`repair-database.php?${params}`);
                const data = await response.json();
                return data;
            } catch (error) {
                throw new Error(error.message);
            }
        }

        async function checkStatus() {
            updateStatus('üîç Checking database status...', 'loading');
            try {
                const result = await call('status');
                if (result.success) {
                    const info = result.data;
                    let message = `Database Status Report\n`;
                    message += `=====================================\n`;
                    message += `Path: ${info.database_path}\n`;
                    message += `Exists: ${info.exists ? '‚úì' : '‚úó'}\n`;
                    if (info.exists) {
                        message += `Readable: ${info.readable ? '‚úì' : '‚úó'}\n`;
                        message += `Writable: ${info.writable ? '‚úì' : '‚úó'}\n`;
                        message += `Size: ${formatBytes(info.size)}\n`;
                        message += `Valid SQLite: ${info.is_valid_sqlite ? '‚úì' : '‚úó'}\n`;
                        message += `Integrity: ${info.integrity}\n`;
                    }
                    message += `Timestamp: ${info.timestamp}\n`;
                    updateStatus(message, info.is_valid_sqlite && info.integrity === 'ok' ? 'success' : info.exists ? 'warning' : 'error');
                } else {
                    updateStatus('Error: ' + result.error, 'error');
                }
            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
            }
        }

        async function backup() {
            updateStatus('üíæ Creating backup...', 'loading');
            try {
                const result = await call('backup');
                if (result.success) {
                    let message = `Backup Created\n`;
                    message += `=====================================\n`;
                    message += `Path: ${result.data.backup_path}\n`;
                    message += `Size: ${formatBytes(result.data.backup_size)}\n`;
                    message += `Timestamp: ${new Date().toLocaleString()}\n`;
                    updateStatus(message, 'success');
                } else {
                    updateStatus('Error: ' + result.error, 'error');
                }
            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
            }
        }

        async function repair() {
            if (!confirm('‚ö†Ô∏è Attempt automatic repair?')) return;
            updateStatus('üîß Attempting repair...', 'loading');
            try {
                const result = await call('repair');
                if (result.success) {
                    let message = `${result.data.message || 'Database repaired'}\n`;
                    message += `=====================================\n`;
                    message += `Status: ${result.data.status}\n`;
                    message += `Timestamp: ${result.data.timestamp}\n`;
                    updateStatus(message, 'success');
                } else {
                    updateStatus('Error: ' + result.error, 'error');
                }
            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
            }
        }

        async function nuke() {
            if (!confirm('üî• CONFIRM: Delete and reinitialize entire database? All data will be lost!')) return;
            updateStatus('üî• Nuking database...', 'loading');
            try {
                const result = await call('nuke');
                if (result.success) {
                    let message = `Database Nuked & Reinitialized\n`;
                    message += `=====================================\n`;
                    message += `Backup: ${result.data.backup?.backup_path || 'N/A'}\n`;
                    message += `Backup Size: ${result.data.backup?.backup_size ? formatBytes(result.data.backup.backup_size) : 'N/A'}\n`;
                    message += `Tables Created: ${result.data.initialization?.tables_created}\n`;
                    message += `Indexes Created: ${result.data.initialization?.indexes_created}\n`;
                    message += `Timestamp: ${result.data.initialization?.timestamp}\n`;
                    updateStatus(message, 'success');
                } else {
                    updateStatus('Error: ' + result.error, 'error');
                }
            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
            }
        }

        async function initialize() {
            if (!confirm('‚ö†Ô∏è Create fresh database? (Will not delete existing data unless corrupted)')) return;
            updateStatus('‚öôÔ∏è Initializing fresh database...', 'loading');
            try {
                const result = await call('initialize');
                if (result.success) {
                    let message = `Fresh Database Initialized\n`;
                    message += `=====================================\n`;
                    message += `Path: ${result.data.database_path}\n`;
                    message += `Tables Created: ${result.data.tables_created}\n`;
                    message += `Indexes Created: ${result.data.indexes_created}\n`;
                    message += `Timestamp: ${result.data.timestamp}\n`;
                    updateStatus(message, 'success');
                } else {
                    updateStatus('Error: ' + result.error, 'error');
                }
            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        checkStatus();
    </script>
</body>
</html>
